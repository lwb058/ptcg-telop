<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Global Settings</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; color: #333; margin: 15px; font-size: 14px; }
        .panel-section { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .panel-section h3 { margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 16px; color: #555; }
        
        #color-settings-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 8px;
        }

        .form-group {
            display: grid;
            grid-template-columns: 20px 40px 1fr 50px; 
            align-items: center;
            gap: 8px;
            margin-bottom: 0;
        }

        .form-group label { font-weight: bold; }
        .form-group input[type="color"], .form-group input[type="range"] {
            width: 100%;
            min-height: 32px;
            padding: 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group input[type="color"] { padding: 2px; }
        
        .form-group .opacity-input-number {
            width: 100%;
            height: 32px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            -moz-appearance: textfield; /* Firefox */
        }
        .form-group .opacity-input-number::-webkit-outer-spin-button,
        .form-group .opacity-input-number::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .btn { display: block; width: 100%; padding: 10px; border: none; border-radius: 5px; background-color: #2196F3; color: white; font-size: 16px; cursor: pointer; transition: background-color 0.2s; }
        .btn:hover { background-color: #1976D2; }

        .collapsible-content {
            padding-top: 10px;
        }

        .setting-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        .form-group-hotkey {
            display: grid;
            grid-template-columns: 220px 1fr;
            align-items: center;
            gap: 10px;
        }
        .form-group-hotkey label {
            font-weight: bold;
        }
        .form-group-hotkey input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .horizontal-panels {
            display: flex;
            flex-wrap: wrap; /* 允许面板在小屏幕上换行 */
            gap: 15px;
            margin-bottom: 15px;
        }
        .horizontal-panels > .panel-section {
            /* flex: 1; -> flex: 1 1 320px; */
            flex: 1 1 320px; /* 允许面板伸缩，并设置一个基础宽度为320px */
            margin-bottom: 0;
            min-height: 250px;
        }

        .panel-section-flex {
            display: flex;
            flex-direction: column;
        }

        /* --- Donation Modal Styles --- */
        .donation-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
        }
        .donation-modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
            text-align: center;
        }
        .donation-modal-close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
        }
        .donation-modal-close:hover,
        .donation-modal-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #donation-content-area {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding-top: 15px;
        }
        #donation-content-area img {
            max-width: 180px;
            height: auto;
        }
        .support-btn {
            margin-top: 10px;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background-color: #ffda0a;
            color: black;
            cursor: pointer;
            display: none; /* Hidden by default, enabled by JS */
        }
        .support-btn:hover {
            background-color: #ffae00;
        }

        .ofuse-custom-btn {
            display: inline-block;
            padding: 12px 24px;
            background-color: #2882a7;
            color: white !important; /* Override default link colors */
            text-decoration: none;
            border-radius: 24px;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        .ofuse-custom-btn:hover {
            background-color: #1f6a8a;
        }

        .qr-code-wechat {
            border: 8px solid #07C160; /* WeChat Green */
            border-radius: 8px;
            box-sizing: border-box;
        }
        .qr-code-alipay {
            border: 8px solid #1678ff; /* Alipay Blue */
            border-radius: 8px;
            box-sizing: border-box;
        }

        summary {
            cursor: pointer;
            list-style-position: inside;
        }

        summary > h4 {
            display: inline;
            margin: 0;
        }

        #update-notification a {
            color: #0056b3;
            font-weight: bold;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="horizontal-panels">
        <div class="panel-section">
            <h3 id="label-basic">Basic</h3>
            <div class="collapsible-content">
                <div class="setting-grid">
                    <div class="form-group-hotkey">
                        <label for="auto-sided-take" id="label-auto-side-take">Auto Side Take</label>
                        <input type="checkbox" id="auto-sided-take" style="width: auto; height: auto; justify-self: end;">
                    </div>
                    <div class="form-group-hotkey">
                        <label for="auto-retreat-toggle" id="label-auto-retreat">Auto Retreat</label>
                        <input type="checkbox" id="auto-retreat-toggle" style="width: auto; height: auto; justify-self: end;">
                    </div>
                    <div class="form-group-hotkey">
                        <label for="auto-check-supporter-toggle" id="label-auto-check-supporter">Auto-check Supporter</label>
                        <input type="checkbox" id="auto-check-supporter-toggle" style="width: auto; height: auto; justify-self: end;">
                    </div>
                    <div class="form-group-hotkey">
                        <label for="auto-trash-tm-toggle" id="label-auto-trash-tm">Auto-Trash TM</label>
                        <input type="checkbox" id="auto-trash-tm-toggle" style="width: auto; height: auto; justify-self: end;">
                    </div>
                    <div class="form-group-hotkey">
                        <label for="show-deck-energy-only-toggle" id="label-show-deck-energy-only">Show Deck Energy Only</label>
                        <input type="checkbox" id="show-deck-energy-only-toggle" style="width: auto; height: auto; justify-self: end;">
                    </div>
                    <div class="form-group-hotkey">
                        <label for="weakness-damage-toggle" id="label-weakness-damage">Auto Double Weakness Damage</label>
                        <input type="checkbox" id="weakness-damage-toggle" style="width: auto; height: auto; justify-self: end;">
                    </div>
                </div>
            </div>
        </div>
        <div class="panel-section">
            <h3 id="label-regulation">Regulation</h3>
            <div class="collapsible-content">
                <div class="setting-grid">
                    <div class="form-group-hotkey">
                        <label for="lost-zone-toggle" id="label-enable-lost-zone">Enable Lost Zone</label>
                        <input type="checkbox" id="lost-zone-toggle" style="width: auto; height: auto; justify-self: end;">
                    </div>
                    <div class="form-group-hotkey">
                        <label for="vstar-toggle" id="label-enable-vstar">Enable VSTAR Power</label>
                        <input type="checkbox" id="vstar-toggle" style="width: auto; height: auto; justify-self: end;">
                    </div>
                </div>
            </div>
        </div>
        <div class="panel-section">
            <h3 id="label-hotkey">Hotkey</h3>
            <div class="collapsible-content">
                <div class="setting-grid">
                    <div class="form-group-hotkey">
                        <label for="discard-hotkey-input">Discard Queue</label>
                        <input type="text" id="discard-hotkey-input" placeholder="e.g., Escape, Alt+D">
                    </div>
                    <div class="form-group-hotkey">
                        <label for="apply-hotkey-input">Apply Queue</label>
                        <input type="text" id="apply-hotkey-input" placeholder="e.g., Ctrl+S, F1">
                    </div>
                    <div class="form-group-hotkey">
                        <label for="clear-card-hotkey-input">Clear Card Display</label>
                        <input type="text" id="clear-card-hotkey-input" placeholder="e.g., Space, C">
                    </div>
                    <div class="form-group-hotkey">
                        <label for="clear-selection-hotkey-input">Clear Selection</label>
                        <input type="text" id="clear-selection-hotkey-input" placeholder="e.g., Escape">
                    </div>
                </div>
            </div>
        </div>
        <div class="panel-section">
            <h3 id="label-appearance">Appearance</h3>
            <div class="collapsible-content">
                <div class="setting-grid">
                    <div class="form-group-hotkey">
                        <label for="theme-select" id="label-theme">Theme</label>
                        <select id="theme-select" class="form-select" style="justify-self: end; width: 100%;"></select>
                    </div>
                </div>
                <hr style="border: none; border-top: 1px solid #eee; margin: 10px 0;">
                <details>
                    <summary><h4 id="label-type-color">Type Color</h4></summary>
                    <div id="color-settings-container" style="padding-top: 10px;">
                        <!-- Color settings will be dynamically inserted here -->
                    </div>
                </details>
            </div>
        </div>
        <div class="panel-section panel-section-flex">
            <h3 id="label-system">System</h3>
            <div class="collapsible-content">
                <div class="setting-grid">
                    <div class="form-group-hotkey">
                        <label for="reverse-card-display-toggle" id="label-reverse-card-display">Reverse Card Display</label>
                        <input type="checkbox" id="reverse-card-display-toggle" style="width: auto; height: auto; justify-self: end;">
                    </div>
                    <div class="form-group-hotkey">
                        <label for="tool-limit-input" id="label-tool-carry-limit">Tool Carry Limit</label>
                        <input type="number" id="tool-limit-input" min="1" max="10" step="1" style="width: 60px; justify-self: end;">
                    </div>
                    <div class="form-group-hotkey">
                        <label for="language-select" id="label-language">Language</label>
                        <select id="language-select" class="form-select">
                            <option value="jp">日本語</option>
                            <option value="chs">简体中文</option>
                            <option value="cht">繁体中文</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
            </div>
            <button id="clear-database-btn" class="btn" style="background-color: #E74C3C; width: auto; align-self: flex-end; margin-top: auto;">Clear Database</button>
        </div>
    </div>

    <div class="panel-section">
        <button id="save-settings-btn" class="btn">Save All Settings</button>
    </div>

    <div class="panel-section" style="display: flex; justify-content: space-between; align-items: center; width: 15%; min-width: 350px; background-color: #f8f9fa;">
        <p style="margin: 0; font-size: 12px; color: #6c757d; text-align: left;">
            ptcg-telop Ver <span id="bundle-version">114.514</span></br>
            Developed by ミニ49. </br>
            <a href="https://github.com/lwb058/ptcg-telop" target="_blank">GitHub</a> | 
            <a href="mailto:lwb058@gmail.com">Email</a> | 
            <a href="https://x.com/i/user/437555697" target="_blank">X (Twitter)</a> | 
            <a href="https://space.bilibili.com/305921" target="_blank">BiliBili</a>
        </p>
        <button id="support-developer-btn" class="support-btn" style="margin-top: 0;"></button>
    </div>

    <div id="update-notification" style="display: none; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; margin: 15px; color: #856404; font-size: 16px;">
        <!-- Update message will be injected here -->
    </div>

    <!-- Donation Modal -->
    <div id="donation-modal" class="donation-modal">
      <div class="donation-modal-content">
        <span id="donation-modal-close-btn" class="donation-modal-close">&times;</span>
        <h3 id="donation-modal-title-text"></h3>
        <div id="donation-content-area">
          <!-- Donation content will be injected here by JavaScript -->
        </div>
      </div>
    </div>

    <script>
        NodeCG.waitForReplicants(
            nodecg.Replicant('ptcg-settings'),
            nodecg.Replicant('i18nStrings'),
            nodecg.Replicant('language'),
            nodecg.Replicant('themeList')
        ).then(() => {
            const settingsRep = nodecg.Replicant('ptcg-settings');
            const i18nStrings = nodecg.Replicant('i18nStrings');
            const themeList = nodecg.Replicant('themeList');
            
            // --- Element References ---
            const colorContainer = document.getElementById('color-settings-container');
            const vstarToggle = document.getElementById('vstar-toggle');
            const autoRetreatToggle = document.getElementById('auto-retreat-toggle');
            const autoSideTake = document.getElementById('auto-sided-take');
            const lostZoneToggle = document.getElementById('lost-zone-toggle');
            const reverseCardDisplayToggle = document.getElementById('reverse-card-display-toggle');
            const showDeckEnergyOnlyToggle = document.getElementById('show-deck-energy-only-toggle');
            const autoCheckSupporterToggle = document.getElementById('auto-check-supporter-toggle');
            const autoTrashTmToggle = document.getElementById('auto-trash-tm-toggle');
            const weaknessDamageToggle = document.getElementById('weakness-damage-toggle');
            const discardHotkeyInput = document.getElementById('discard-hotkey-input');
            const applyHotkeyInput = document.getElementById('apply-hotkey-input');
            const clearCardHotkeyInput = document.getElementById('clear-card-hotkey-input');
            const clearSelectionHotkeyInput = document.getElementById('clear-selection-hotkey-input');
            const toolLimitInput = document.getElementById('tool-limit-input');
            const themeSelect = document.getElementById('theme-select');
            const languageSelect = document.getElementById('language-select');
            const saveBtn = document.getElementById('save-settings-btn');
            const clearDbBtn = document.getElementById('clear-database-btn');
            
            const getI18nText = (key) => {
                const lang = settingsRep.value ? settingsRep.value.language : 'jp';
                if (!i18nStrings.value || !i18nStrings.value[key] || !lang) {
                    return key;
                }
                return i18nStrings.value[key][lang] || i18nStrings.value[key]['jp'] || key;
            };

            function updateAllLabels() {
                document.getElementById('label-basic').textContent = getI18nText('settings_basic');
                document.getElementById('label-auto-side-take').textContent = getI18nText('settings_auto_side_take');
                document.getElementById('label-auto-retreat').textContent = getI18nText('settings_auto_retreat');
                document.getElementById('label-auto-check-supporter').textContent = getI18nText('settings_auto_check_supporter');
                document.getElementById('label-auto-trash-tm').textContent = getI18nText('settings_auto_trash_tm');
                document.getElementById('label-show-deck-energy-only').textContent = getI18nText('settings_show_deck_energy_only');
                document.getElementById('label-weakness-damage').textContent = getI18nText('settings_auto_double_weakness_damage');
                document.getElementById('label-regulation').textContent = getI18nText('settings_regulation');
                document.getElementById('label-enable-lost-zone').textContent = getI18nText('settings_enable_lost_zone');
                document.getElementById('label-enable-vstar').textContent = getI18nText('settings_enable_vstar');
                document.getElementById('label-hotkey').textContent = getI18nText('settings_hotkey');
                document.getElementById('label-system').textContent = getI18nText('settings_system');
                document.getElementById('label-reverse-card-display').textContent = getI18nText('settings_reverse_card_display');
                document.getElementById('label-appearance').textContent = getI18nText('settings_appearance');
                document.getElementById('label-theme').textContent = getI18nText('settings_theme');
                document.getElementById('label-type-color').textContent = getI18nText('settings_type_color_title');
                document.getElementById('label-tool-carry-limit').textContent = getI18nText('settings_tool_carry_limit');
                document.getElementById('label-language').textContent = getI18nText('settings_language');
                document.getElementById('clear-database-btn').textContent = getI18nText('settings_clear_database');
                if (document.getElementById('support-developer-btn')) {
                    document.getElementById('support-developer-btn').textContent = getI18nText('settings_support_button');
                }
            }

            clearDbBtn.addEventListener('click', () => {
                const confirmation = confirm("Are you sure you want to clear the entire card database and all downloaded images? This cannot be undone.");
                if (confirmation) {
                    nodecg.sendMessage('clearDatabase')
                        .then(() => {
                            alert('Database and card images have been cleared.');
                        })
                        .catch(e => {
                            console.error("Failed to clear database:", e);
                            alert(`Failed to clear database: ${e.message}`);
                        });
                }
            });

            let renderedColorElements = {};

            function updateThemeDropdown(availableThemes, activeTheme) {
                if (!themeSelect) return;
                themeSelect.innerHTML = '';
                availableThemes.forEach(themeName => {
                    const option = document.createElement('option');
                    option.value = themeName;
                    option.textContent = themeName;
                    themeSelect.appendChild(option);
                });
                themeSelect.value = activeTheme || 'Default';
            }

            function renderAll(settings) {
                // 1. Render Color Settings
                colorContainer.innerHTML = '';
                renderedColorElements = {};
                const colorMap = (settings && settings.typeColorMap) ? settings.typeColorMap : {};
                const allPossibleTypes = {
                    '草': { color: '#4DAD5B', opacity: 1.0 }, '炎': { color: '#F4813E', opacity: 1.0 },
                    '水': { color: '#4299E1', opacity: 1.0 }, '雷': { color: '#FBD100', opacity: 1.0 },
                    '超': { color: '#9A549A', opacity: 1.0 }, '闘': { color: '#C46A3A', opacity: 1.0 },
                    '悪': { color: '#705848', opacity: 1.0 }, '鋼': { color: '#B8B8D0', opacity: 1.0 },
                    '無': { color: '#A8A878', opacity: 1.0 }, 
                    '妖': { color: '#E08EE0', opacity: 1.0 }, '竜': { color: '#7038F8', opacity: 1.0 },
                };
                const typeKeys = Object.keys(allPossibleTypes);
                typeKeys.forEach(type => {
                    const setting = colorMap[type] || allPossibleTypes[type] || { color: '#ffffff', opacity: 1.0 };
                    const colorValue = setting.color;
                    const opacityValue = setting.opacity;
                    const opacityPercent = Math.round(opacityValue * 100);
                    const formGroup = document.createElement('div');
                    formGroup.classList.add('form-group');
                    const label = document.createElement('label');
                    label.textContent = type;
                    const colorInput = document.createElement('input');
                    colorInput.type = 'color';
                    colorInput.value = colorValue;
                    const opacitySlider = document.createElement('input');
                    opacitySlider.type = 'range';
                    opacitySlider.min = 0;
                    opacitySlider.max = 100;
                    opacitySlider.step = 1;
                    opacitySlider.value = opacityPercent;
                    const opacityNumberInput = document.createElement('input');
                    opacityNumberInput.type = 'number';
                    opacityNumberInput.min = 0;
                    opacityNumberInput.max = 100;
                    opacityNumberInput.value = opacityPercent;
                    opacityNumberInput.classList.add('opacity-input-number');
                    opacitySlider.addEventListener('input', () => { opacityNumberInput.value = opacitySlider.value; });
                    opacityNumberInput.addEventListener('input', () => { opacitySlider.value = opacityNumberInput.value; });
                    opacityNumberInput.addEventListener('change', () => {
                        let value = parseInt(opacityNumberInput.value, 10);
                        if (isNaN(value) || value < 0) value = 0;
                        if (value > 100) value = 100;
                        opacityNumberInput.value = value;
                        opacitySlider.value = value;
                    });
                    formGroup.appendChild(label);
                    formGroup.appendChild(colorInput);
                    formGroup.appendChild(opacitySlider);
                    formGroup.appendChild(opacityNumberInput);
                    colorContainer.appendChild(formGroup);
                    renderedColorElements[type] = { colorInput, opacityNumberInput };
                });

                // 2. Render Appearance Settings
                vstarToggle.checked = !!(settings && settings.vstarEnabled);
                autoRetreatToggle.checked = !!(settings && settings.autoRetreatToggle);
                autoSideTake.checked = !!(settings && settings.autoSideTake);
                lostZoneToggle.checked = !!(settings && settings.lostZoneEnabled);
                reverseCardDisplayToggle.checked = !!(settings && settings.reverseCardDisplay);
                showDeckEnergyOnlyToggle.checked = !!(settings && settings.showDeckEnergyOnly);
                autoCheckSupporterToggle.checked = !!(settings && settings.autoCheckSupporter);
                autoTrashTmToggle.checked = !!(settings && settings.autoTrashTM);
                weaknessDamageToggle.checked = !!(settings && settings.weaknessDamage);
                toolLimitInput.value = (settings && settings.toolLimit) ? settings.toolLimit : 4;
                languageSelect.value = (settings && settings.language) ? settings.language : "jp";
                
                // Update theme dropdown
                updateThemeDropdown(themeList.value || ['Default'], settings ? settings.activeTheme : 'Default');

                // 3. Render Hotkey Settings
                const hotkeys = (settings && settings.hotkeys) ? settings.hotkeys : {};
                discardHotkeyInput.value = hotkeys.discard || 'Escape';
                applyHotkeyInput.value = hotkeys.apply || 'Control+S';
                clearCardHotkeyInput.value = hotkeys.clearCard || 'Space';
                clearSelectionHotkeyInput.value = hotkeys.clearSelection || 'Escape';
            }

            settingsRep.on('change', (newValue) => {
                renderAll(newValue);
                updateAllLabels();
            });

            themeList.on('change', (newThemeList) => {
                updateThemeDropdown(newThemeList || ['Default'], settingsRep.value ? settingsRep.value.activeTheme : 'Default');
            });

            saveBtn.addEventListener('click', () => {
                const newColorMap = {};
                const types = Object.keys(renderedColorElements);
                types.forEach(type => {
                    const elements = renderedColorElements[type];
                    if (elements && elements.colorInput && elements.opacityNumberInput) {
                        let value = parseInt(elements.opacityNumberInput.value, 10);
                        if (isNaN(value) || value < 0) value = 0;
                        if (value > 100) value = 100;
                        newColorMap[type] = {
                            color: elements.colorInput.value,
                            opacity: value / 100
                        };
                    }
                });

                const newHotkeys = {
                    discard: discardHotkeyInput.value.trim() || 'Escape',
                    apply: applyHotkeyInput.value.trim() || 'Control+S',
                    clearCard: clearCardHotkeyInput.value.trim() || 'Space',
                    clearSelection: clearSelectionHotkeyInput.value.trim() || 'Escape'
                };

                const newVstarEnabled = vstarToggle.checked;
                const newAutoRetreatToggle = autoRetreatToggle.checked;
                const newAutoSideTake = autoSideTake.checked;
                const newLostZoneEnabled = lostZoneToggle.checked;
                const newReverseCardDisplay = reverseCardDisplayToggle.checked;
                const newShowDeckEnergyOnly = showDeckEnergyOnlyToggle.checked;
                const newAutoCheckSupporter = autoCheckSupporterToggle.checked;
                const newAutoTrashTM = autoTrashTmToggle.checked;
                const newWeaknessDamage = weaknessDamageToggle.checked;
                const newActiveTheme = themeSelect.value;
                const newToolLimit = parseInt(toolLimitInput.value, 10) || 4;
                const newLanguage = languageSelect.value;
                
                const currentSettings = settingsRep.value || {};
                // Make sure to not include the old useCustomAppearance setting
                const { useCustomAppearance, ...restOfSettings } = currentSettings;

                settingsRep.value = { 
                    ...restOfSettings,
                    typeColorMap: newColorMap,
                    hotkeys: newHotkeys,
                    vstarEnabled: newVstarEnabled,
                    autoRetreatToggle: newAutoRetreatToggle,
                    autoSideTake: newAutoSideTake,
                    lostZoneEnabled: newLostZoneEnabled,
                    reverseCardDisplay: newReverseCardDisplay,
                    showDeckEnergyOnly: newShowDeckEnergyOnly,
                    autoCheckSupporter: newAutoCheckSupporter,
                    autoTrashTM: newAutoTrashTM,
                    weaknessDamage: newWeaknessDamage,
                    activeTheme: newActiveTheme,
                    toolLimit: newToolLimit,
                    language: newLanguage
                };
                saveBtn.textContent = 'Saved!';
                updateAllLabels();
                setTimeout(() => {
                    saveBtn.textContent = 'Save All Settings';
                }, 1500);
            });

            const versionSpan = document.getElementById('bundle-version');
            if (versionSpan) {
                nodecg.sendMessage('getBundleVersion', (err, version) => {
                    if (err) {
                        console.error("Failed to get bundle version:", err);
                        return;
                    }
                    if (version) {
                        versionSpan.textContent = version;
                    }
                });
            }

            const supportBtn = document.getElementById('support-developer-btn');
            const donationModal = document.getElementById('donation-modal');
            const closeModalBtn = document.getElementById('donation-modal-close-btn');
            const donationModalTitle = document.getElementById('donation-modal-title-text');
            const donationContentArea = document.getElementById('donation-content-area');

            if (nodecg.bundleConfig && nodecg.bundleConfig.donation_links) {
                supportBtn.style.display = 'inline-block';
                const links = nodecg.bundleConfig.donation_links;
                supportBtn.addEventListener('click', () => {
                    const lang = settingsRep.value ? settingsRep.value.language : 'jp';
                    donationModalTitle.textContent = getI18nText('donation_modal_title');
                    donationContentArea.innerHTML = '';
                    switch (lang) {
                        case 'chs':
                            if (links.wechat_qr_url) donationContentArea.innerHTML += `<img class="qr-code-wechat" src="${links.wechat_qr_url}" alt="WeChat Pay">`;
                            if (links.alipay_qr_url) donationContentArea.innerHTML += `<img class="qr-code-alipay" src="${links.alipay_qr_url}" alt="Alipay">`;
                            break;
                        case 'jp':
                            if (links.ofuse_url) donationContentArea.innerHTML = `<a href="${links.ofuse_url}" target="_blank" rel="noopener noreferrer" class="ofuse-custom-btn">OFUSEで応援を送る</a>`;
                            break;
                        default:
                            if (links.buy_me_a_coffee_url) donationContentArea.innerHTML = `<a href="${links.buy_me_a_coffee_url}" target="_blank" rel="noopener noreferrer"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a>`;
                            break;
                    }
                    donationModal.style.display = 'block';
                });
                closeModalBtn.addEventListener('click', () => { donationModal.style.display = 'none'; });
                window.addEventListener('click', (event) => {
                    if (event.target == donationModal) {
                        donationModal.style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>
</html>