<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Global Settings</title>
	<link rel="stylesheet" href="css/dashboard.css">
</head>

<body>
	<div class="horizontal-panels">
		<div class="panel-section">
			<h3 id="label-basic">Basic</h3>
			<div class="collapsible-content">
				<div class="setting-grid">
					<div class="form-group-hotkey">
						<label for="auto-prize-take" id="label-auto-prize-take">Auto Prize Take</label>
						<input type="checkbox" id="auto-prize-take"
							style="width: auto; height: auto; justify-self: end;">
					</div>
					<div class="form-group-hotkey">
						<label for="auto-retreat-toggle" id="label-auto-retreat">Auto Retreat</label>
						<input type="checkbox" id="auto-retreat-toggle"
							style="width: auto; height: auto; justify-self: end;">
					</div>
					<div class="form-group-hotkey">
						<label for="auto-check-supporter-toggle" id="label-auto-check-supporter">Auto-check
							Supporter</label>
						<input type="checkbox" id="auto-check-supporter-toggle"
							style="width: auto; height: auto; justify-self: end;">
					</div>
					<div class="form-group-hotkey">
						<label for="auto-trash-tm-toggle" id="label-auto-trash-tm">Auto-Trash TM</label>
						<input type="checkbox" id="auto-trash-tm-toggle"
							style="width: auto; height: auto; justify-self: end;">
					</div>
					<div class="form-group-hotkey">
						<label for="show-deck-energy-only-toggle" id="label-show-deck-energy-only">Show Deck Energy
							Only</label>
						<input type="checkbox" id="show-deck-energy-only-toggle"
							style="width: auto; height: auto; justify-self: end;">
					</div>
					<div class="form-group-hotkey">
						<label for="weakness-damage-toggle" id="label-weakness-damage">Auto Double Weakness
							Damage</label>
						<input type="checkbox" id="weakness-damage-toggle"
							style="width: auto; height: auto; justify-self: end;">
					</div>
					<div class="form-group-hotkey">
						<label for="time-limit-input" id="label-time-limit">Time Limit (min, 0 to disable)</label>
						<div style=" justify-self: end;">
							<input type="number" id="time-limit-input" min="0" max="60" step="1" style="width: 60px;">
							min
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="panel-section">
			<h3 id="label-regulation">Regulation</h3>
			<div class="collapsible-content">
				<div class="setting-grid">
					<div class="form-group-hotkey">
						<label for="lost-zone-toggle" id="label-enable-lost-zone">Enable Lost Zone</label>
						<input type="checkbox" id="lost-zone-toggle"
							style="width: auto; height: auto; justify-self: end;">
					</div>
					<div class="form-group-hotkey">
						<label for="vstar-toggle" id="label-enable-vstar">Enable VSTAR Power</label>
						<input type="checkbox" id="vstar-toggle" style="width: auto; height: auto; justify-self: end;">
					</div>
				</div>
			</div>
		</div>
		<div class="panel-section">
			<h3 id="label-hotkey">Hotkey</h3>
			<div class="collapsible-content">
				<div class="setting-grid">
					<div class="form-group-hotkey">
						<label for="discard-hotkey-mod">Discard Queue</label>
						<div style="display: flex; gap: 5px; justify-self: end;">
							<select id="discard-hotkey-mod" class="hotkey-mod-select"></select>
							<label for="discard-hotkey-mod"> + </label>
							<input type="text" id="discard-hotkey-key" class="hotkey-key-input" maxlength="1"
								placeholder="None">
						</div>
					</div>
					<div class="form-group-hotkey">
						<label for="apply-hotkey-mod">Apply Queue</label>
						<div style="display: flex; gap: 5px; justify-self: end;">
							<select id="apply-hotkey-mod" class="hotkey-mod-select"></select>
							<label for="discard-hotkey-mod"> + </label>
							<input type="text" id="apply-hotkey-key" class="hotkey-key-input" maxlength="1"
								placeholder="None">
						</div>
					</div>
					<div class="form-group-hotkey">
						<label for="clear-card-hotkey-mod">Clear Card Display</label>
						<div style="display: flex; gap: 5px; justify-self: end;">
							<select id="clear-card-hotkey-mod" class="hotkey-mod-select"></select>
							<label for="discard-hotkey-mod"> + </label>
							<input type="text" id="clear-card-hotkey-key" class="hotkey-key-input" maxlength="1"
								placeholder="None">
						</div>
					</div>
					<div class="form-group-hotkey">
						<label for="clear-selection-hotkey-mod">Clear Selection</label>
						<div style="display: flex; gap: 5px; justify-self: end;">
							<select id="clear-selection-hotkey-mod" class="hotkey-mod-select"></select>
							<label for="discard-hotkey-mod"> + </label>
							<input type="text" id="clear-selection-hotkey-key" class="hotkey-key-input" maxlength="1"
								placeholder="None">
						</div>
					</div>
					<div class="form-group-hotkey">
						<label for="peek-opponent-hotkey-mod">Peek Opponent Field</label>
						<div style="display: flex; gap: 5px; justify-self: end;">
							<select id="peek-opponent-hotkey-mod" class="hotkey-mod-select"></select>
							<label for="discard-hotkey-mod"> + </label>
							<input type="text" id="peek-opponent-hotkey-key" class="hotkey-key-input" maxlength="1"
								placeholder="None">
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="panel-section">
			<h3 id="label-appearance">Appearance</h3>
			<div class="collapsible-content">
				<div class="setting-grid">
					<div class="form-group-hotkey">
						<label for="theme-select" id="label-theme">Theme</label>
						<select id="theme-select" class="form-select" style="justify-self: end; width: 100%;"></select>
					</div>
				</div>
				<hr style="border: none; border-top: 1px solid #eee; margin: 10px 0;">
				<details>
					<summary>
						<h4 id="label-type-color">Type Color</h4>
					</summary>
					<div id="color-settings-container" style="padding-top: 10px;">
						<!-- Color settings will be dynamically inserted here -->
					</div>
				</details>
			</div>
		</div>
		<div class="panel-section panel-section-flex">
			<h3 id="label-system">System</h3>
			<div class="collapsible-content">
				<div class="setting-grid">
					<div class="form-group-hotkey">
						<label for="reverse-card-display-toggle" id="label-reverse-card-display">Reverse Card
							Display</label>
						<input type="checkbox" id="reverse-card-display-toggle"
							style="width: auto; height: auto; justify-self: end;">
					</div>
					<div class="form-group-hotkey">
						<label for="force-refetch-deck-toggle" id="label-force-refetch-deck">Force Re-fetch Deck</label>
						<input type="checkbox" id="force-refetch-deck-toggle"
							style="width: auto; height: auto; justify-self: end;">
					</div>
					<div class="form-group-hotkey">
						<label for="tool-limit-input" id="label-tool-carry-limit">Tool Carry Limit</label>
						<input type="number" id="tool-limit-input" min="1" max="10" step="1"
							style="width: 60px; justify-self: end;">
					</div>
					<div class="form-group-hotkey">
						<label for="language-select" id="label-language">Language</label>
						<select id="language-select" class="form-select">
							<option value="jp">æ—¥æœ¬èª</option>
							<option value="chs">ç®€ä½“ä¸­æ–‡</option>
							<option value="cht">ç¹ä½“ä¸­æ–‡</option>
							<option value="en">English</option>
						</select>
					</div>
				</div>
			</div>
			<button id="clear-database-btn" class="btn btn-danger"
				style="width: auto; align-self: flex-end; margin-top: 25px;">Clear Database</button>
		</div>
	</div>

	<div class="panel-section"
		style="display: flex; justify-content: center; align-items: center; min-width: 350px; max-width: None; margin-top: 15px;">
		<button id="save-settings-btn" class="btn btn-primary">Save All Settings</button>
	</div>

	<div class="panel-section"
		style="display: flex; justify-content: space-between; align-items: center; width: 15%; min-width: 350px; background-color: #f8f9fa;">
		<p style="margin: 0; font-size: 12px; color: #6c757d; text-align: left;">
			ptcg-telop Ver <span id="bundle-version">114.514</span></br>
			Developed by ãƒŸãƒ‹49. </br>
			<a href="https://github.com/lwb058/ptcg-telop" target="_blank">GitHub</a> |
			<a href="mailto:lwb058@gmail.com">Email</a> |
			<a href="https://x.com/i/user/437555697" target="_blank">X (Twitter)</a> |
			<a href="https://space.bilibili.com/305921" target="_blank">BiliBili</a>
		</p>
		<button id="support-developer-btn" class="support-btn" style="margin-top: 0;"></button>
	</div>

	<div id="update-notification"
		style="display: none; width: 15%; min-width: 350px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; color: #856404; font-size: 14px;">
		<!-- Update message will be injected here -->
	</div>

	<!-- Donation Modal -->
	<div id="donation-modal" class="donation-modal">
		<div class="donation-modal-content">
			<span id="donation-modal-close-btn" class="donation-modal-close">&times;</span>
			<h3 id="donation-modal-title-text"></h3>
			<div id="donation-content-area">
				<!-- Donation content will be injected here by JavaScript -->
			</div>
		</div>
	</div>

	<script>
		NodeCG.waitForReplicants(
			nodecg.Replicant('ptcg-settings'),
			nodecg.Replicant('i18nStrings'),
			nodecg.Replicant('language'),
			nodecg.Replicant('themeList'),
			nodecg.Replicant('bundleVersion'), // Added replicant
			nodecg.Replicant('updateInfo'),
			nodecg.Replicant('gameTimeSettings')
		).then(() => {
			const settingsRep = nodecg.Replicant('ptcg-settings');
			const i18nStrings = nodecg.Replicant('i18nStrings');
			const themeList = nodecg.Replicant('themeList');
			const gameTimeSettings = nodecg.Replicant('gameTimeSettings');

			// --- Element References ---
			const colorContainer = document.getElementById('color-settings-container');
			const vstarToggle = document.getElementById('vstar-toggle');
			const autoRetreatToggle = document.getElementById('auto-retreat-toggle');
			const autoPrizeTake = document.getElementById('auto-prize-take');
			const lostZoneToggle = document.getElementById('lost-zone-toggle');
			const reverseCardDisplayToggle = document.getElementById('reverse-card-display-toggle');
			const showDeckEnergyOnlyToggle = document.getElementById('show-deck-energy-only-toggle');
			const autoCheckSupporterToggle = document.getElementById('auto-check-supporter-toggle');
			const autoTrashTmToggle = document.getElementById('auto-trash-tm-toggle');
			const weaknessDamageToggle = document.getElementById('weakness-damage-toggle');
			const timeLimitInput = document.getElementById('time-limit-input');

			// Hotkey Elements
			const hotkeyIds = ['discard', 'apply', 'clear-card', 'clear-selection', 'peek-opponent'];
			const hotkeyElements = {};
			hotkeyIds.forEach(id => {
				hotkeyElements[id] = {
					mod: document.getElementById(`${id}-hotkey-mod`),
					key: document.getElementById(`${id}-hotkey-key`)
				};
			});

			const toolLimitInput = document.getElementById('tool-limit-input');
			const themeSelect = document.getElementById('theme-select');
			const languageSelect = document.getElementById('language-select');
			const saveBtn = document.getElementById('save-settings-btn');
			const clearDbBtn = document.getElementById('clear-database-btn');
			const forceRefetchDeckToggle = document.getElementById('force-refetch-deck-toggle');

			const getI18nText = (key) => {
				const lang = settingsRep.value ? settingsRep.value.language : 'jp';
				if (!i18nStrings.value || !i18nStrings.value[key] || !lang) {
					return key;
				}
				return i18nStrings.value[key][lang] || i18nStrings.value[key]['jp'] || key;
			};

			function updateAllLabels() {
				document.getElementById('label-basic').textContent = getI18nText('settings_basic');
				document.getElementById('label-auto-prize-take').textContent = getI18nText('settings_auto_prize_take');
				document.getElementById('label-auto-retreat').textContent = getI18nText('settings_auto_retreat');
				document.getElementById('label-auto-check-supporter').textContent = getI18nText('settings_auto_check_supporter');
				document.getElementById('label-auto-trash-tm').textContent = getI18nText('settings_auto_trash_tm');
				document.getElementById('label-show-deck-energy-only').textContent = getI18nText('settings_show_deck_energy_only');
				document.getElementById('label-weakness-damage').textContent = getI18nText('settings_auto_double_weakness_damage');
				document.getElementById('label-regulation').textContent = getI18nText('settings_regulation');
				document.getElementById('label-enable-lost-zone').textContent = getI18nText('settings_enable_lost_zone');
				document.getElementById('label-enable-vstar').textContent = getI18nText('settings_enable_vstar');
				document.getElementById('label-time-limit').textContent = getI18nText('setting_countdown_time');
				document.getElementById('label-hotkey').textContent = getI18nText('settings_hotkey');
				document.getElementById('label-system').textContent = getI18nText('settings_system');
				document.getElementById('label-reverse-card-display').textContent = getI18nText('settings_reverse_card_display');
				document.getElementById('label-appearance').textContent = getI18nText('settings_appearance');
				document.getElementById('label-theme').textContent = getI18nText('settings_theme');
				document.getElementById('label-type-color').textContent = getI18nText('settings_type_color_title');
				document.getElementById('label-tool-carry-limit').textContent = getI18nText('settings_tool_carry_limit');
				document.getElementById('label-language').textContent = getI18nText('settings_language');
				document.getElementById('clear-database-btn').textContent = getI18nText('settings_clear_database');
				document.getElementById('label-force-refetch-deck').textContent = getI18nText('settings_force_refetch_data');
				if (document.getElementById('support-developer-btn')) {
					document.getElementById('support-developer-btn').textContent = getI18nText('settings_support_button');
				}
			}

			clearDbBtn.addEventListener('click', () => {
				const confirmation = confirm("Are you sure you want to clear the entire card database and all downloaded images? This cannot be undone.");
				if (confirmation) {
					nodecg.sendMessage('clearDatabase')
						.then(() => {
							alert('Database and card images have been cleared.');
						})
						.catch(e => {
							console.error("Failed to clear database:", e);
							alert(`Failed to clear database: ${e.message}`);
						});
				}
			});

			let renderedColorElements = {};

			function updateThemeDropdown(availableThemes, activeTheme) {
				if (!themeSelect) return;
				themeSelect.innerHTML = '';
				availableThemes.forEach(themeName => {
					const option = document.createElement('option');
					option.value = themeName;
					option.textContent = themeName;
					themeSelect.appendChild(option);
				});
				themeSelect.value = activeTheme || 'Default';
			}

			function renderAll(settings) {
				// 1. Render Color Settings
				colorContainer.innerHTML = '';
				renderedColorElements = {};
				const colorMap = (settings && settings.typeColorMap) ? settings.typeColorMap : {};
				const allPossibleTypes = {
					'è‰': { color: '#4DAD5B', opacity: 1.0 }, 'ç‚': { color: '#F4813E', opacity: 1.0 },
					'æ°´': { color: '#4299E1', opacity: 1.0 }, 'é›·': { color: '#FBD100', opacity: 1.0 },
					'è¶…': { color: '#9A549A', opacity: 1.0 }, 'é—˜': { color: '#C46A3A', opacity: 1.0 },
					'æ‚ª': { color: '#705848', opacity: 1.0 }, 'é‹¼': { color: '#B8B8D0', opacity: 1.0 },
					'ç„¡': { color: '#A8A878', opacity: 1.0 },
					'å¦–': { color: '#E08EE0', opacity: 1.0 }, 'ç«œ': { color: '#7038F8', opacity: 1.0 },
				};
				const typeKeys = Object.keys(allPossibleTypes);
				typeKeys.forEach(type => {
					const setting = colorMap[type] || allPossibleTypes[type] || { color: '#ffffff', opacity: 1.0 };
					const colorValue = setting.color;
					const opacityValue = setting.opacity;
					const opacityPercent = Math.round(opacityValue * 100);
					const formGroup = document.createElement('div');
					formGroup.classList.add('form-group');
					const label = document.createElement('label');
					label.textContent = type;
					const colorInput = document.createElement('input');
					colorInput.type = 'color';
					colorInput.value = colorValue;
					const opacitySlider = document.createElement('input');
					opacitySlider.type = 'range';
					opacitySlider.min = 0;
					opacitySlider.max = 100;
					opacitySlider.step = 1;
					opacitySlider.value = opacityPercent;
					const opacityNumberInput = document.createElement('input');
					opacityNumberInput.type = 'number';
					opacityNumberInput.min = 0;
					opacityNumberInput.max = 100;
					opacityNumberInput.value = opacityPercent;
					opacityNumberInput.classList.add('opacity-input-number');
					opacitySlider.addEventListener('input', () => { opacityNumberInput.value = opacitySlider.value; });
					opacityNumberInput.addEventListener('input', () => { opacitySlider.value = opacityNumberInput.value; });
					opacityNumberInput.addEventListener('change', () => {
						let value = parseInt(opacityNumberInput.value, 10);
						if (isNaN(value) || value < 0) value = 0;
						if (value > 100) value = 100;
						opacityNumberInput.value = value;
						opacitySlider.value = value;
					});
					formGroup.appendChild(label);
					formGroup.appendChild(colorInput);
					formGroup.appendChild(opacitySlider);
					formGroup.appendChild(opacityNumberInput);
					colorContainer.appendChild(formGroup);
					renderedColorElements[type] = { colorInput, opacityNumberInput };
				});

				// 2. Render Appearance Settings
				vstarToggle.checked = !!(settings && settings.vstarEnabled);
				autoRetreatToggle.checked = !!(settings && settings.autoRetreatToggle);
				autoPrizeTake.checked = !!(settings && settings.autoPrizeTake);
				lostZoneToggle.checked = !!(settings && settings.lostZoneEnabled);
				reverseCardDisplayToggle.checked = !!(settings && settings.reverseCardDisplay);
				showDeckEnergyOnlyToggle.checked = !!(settings && settings.showDeckEnergyOnly);
				autoCheckSupporterToggle.checked = !!(settings && settings.autoCheckSupporter);
				autoTrashTmToggle.checked = !!(settings && settings.autoTrashTM);
				forceRefetchDeckToggle.checked = !!(settings && settings.forceRefetchDeck);
				weaknessDamageToggle.checked = !!(settings && settings.weaknessDamage);
				toolLimitInput.value = (settings && settings.toolLimit) ? settings.toolLimit : 4;
				languageSelect.value = (settings && settings.language) ? settings.language : "jp";

				// Render Game Time Settings
				if (gameTimeSettings.value) {
					if (gameTimeSettings.value.useCountdown) {
						timeLimitInput.value = Math.floor(gameTimeSettings.value.limit / 60);
					} else {
						timeLimitInput.value = 0;
					}
				}

				// Update theme dropdown
				updateThemeDropdown(themeList.value || ['Default'], settings ? settings.activeTheme : 'Default');

				// --- Hotkey Logic ---
				const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;

				function populateHotkeyDropdowns() {
					const options = [
						{ value: 'none', label: 'None' },
						{ value: 'ctrl', label: isMac ? 'Command' : 'Ctrl' },
						{ value: 'alt', label: isMac ? 'Option' : 'Alt' },
						{ value: 'shift', label: 'Shift' },
						{ value: 'meta', label: isMac ? 'Control' : 'Win' },
						{ value: 'space', label: 'Space', special: true },
						{ value: 'enter', label: 'Enter', special: true },
						{ value: 'tab', label: 'Tab', special: true },
						{ value: 'escape', label: 'Escape', special: true },
						{ value: 'delete', label: 'Delete', special: true },
						{ value: 'backspace', label: 'BackSpace', special: true }
					];

					hotkeyIds.forEach(id => {
						const select = hotkeyElements[id].mod;
						const input = hotkeyElements[id].key;
						select.innerHTML = '';
						options.forEach(opt => {
							const el = document.createElement('option');
							el.value = opt.value;
							el.textContent = opt.label;
							select.appendChild(el);
						});
					});
				}
				populateHotkeyDropdowns();

				function parseHotkey(hotkeyString) {
					if (!hotkeyString) return { mod: 'none', key: '' };

					const lower = hotkeyString.toLowerCase();
					const parts = lower.split('+').map(p => p.trim());

					// Known dropdown values (modifiers + special keys)
					const dropdownValues = ['ctrl', 'alt', 'shift', 'meta', 'win', 'space', 'enter', 'tab', 'escape', 'delete', 'backspace'];

					// Case 1: Single part
					if (parts.length === 1) {
						const part = parts[0];
						if (dropdownValues.includes(part)) {
							// It's a special key or modifier used as a key
							return { mod: part === 'win' ? 'meta' : part, key: '' };
						} else {
							// It's a regular key
							return { mod: 'none', key: part };
						}
					}

					// Case 2: Multiple parts (Mod + Key)
					let mod = 'none';
					let key = parts.pop(); // The last part is the key

					if (parts.includes('ctrl')) mod = 'ctrl';
					else if (parts.includes('alt')) mod = 'alt';
					else if (parts.includes('shift')) mod = 'shift';
					else if (parts.includes('meta') || parts.includes('win')) mod = 'meta';

					return { mod, key };
				}

				function renderHotkeys(settings) {
					const hotkeys = (settings && settings.hotkeys) ? settings.hotkeys : {};

					const mappings = {
						'discard': hotkeys.discard || 'Escape',
						'apply': hotkeys.apply || 'Shift+S',
						'clear-card': hotkeys.clearCard || 'Space',
						'clear-selection': hotkeys.clearSelection || 'Escape',
						'peek-opponent': hotkeys.peekOpponent || 'Tab'
					};

					hotkeyIds.forEach(id => {
						const parsed = parseHotkey(mappings[id]);
						hotkeyElements[id].mod.value = parsed.mod;
						hotkeyElements[id].key.value = parsed.key;
					});
				}

				// 3. Render Hotkey Settings
				renderHotkeys(settings);
			}

			settingsRep.on('change', (newValue) => {
				renderAll(newValue);
				updateAllLabels();
			});

			gameTimeSettings.on('change', () => {
				renderAll(settingsRep.value);
			});

			themeList.on('change', (newThemeList) => {
				updateThemeDropdown(newThemeList || ['Default'], settingsRep.value ? settingsRep.value.activeTheme : 'Default');
			});

			saveBtn.addEventListener('click', () => {
				const newColorMap = {};
				const types = Object.keys(renderedColorElements);
				types.forEach(type => {
					const elements = renderedColorElements[type];
					if (elements && elements.colorInput && elements.opacityNumberInput) {
						let value = parseInt(elements.opacityNumberInput.value, 10);
						if (isNaN(value) || value < 0) value = 0;
						if (value > 100) value = 100;
						newColorMap[type] = {
							color: elements.colorInput.value,
							opacity: value / 100
						};
					}
				});

				function getHotkeyString(id) {
					const mod = hotkeyElements[id].mod.value;
					const key = hotkeyElements[id].key.value.trim();

					// Case 4: None + Empty -> No Hotkey
					if (mod === 'none' && !key) {
						return '';
					}

					// Case 1: Dropdown Val + Empty -> Dropdown Val
					if (mod !== 'none' && !key) {
						return mod.charAt(0).toUpperCase() + mod.slice(1);
					}

					// Case 2: None + Val -> Val
					if (mod === 'none' && key) {
						return key;
					}

					// Case 3: Dropdown Val + Val -> Val+Val
					// Capitalize modifier for standard format
					const modDisplay = mod.charAt(0).toUpperCase() + mod.slice(1);
					return `${modDisplay}+${key.toUpperCase()}`;
				}

				const newHotkeys = {
					discard: getHotkeyString('discard'),
					apply: getHotkeyString('apply'),
					clearCard: getHotkeyString('clear-card'),
					clearSelection: getHotkeyString('clear-selection'),
					peekOpponent: getHotkeyString('peek-opponent')
				};

				const newVstarEnabled = vstarToggle.checked;
				const newAutoRetreatToggle = autoRetreatToggle.checked;
				const newAutoPrizeTake = autoPrizeTake.checked;
				const newLostZoneEnabled = lostZoneToggle.checked;
				const newReverseCardDisplay = reverseCardDisplayToggle.checked;
				const newShowDeckEnergyOnly = showDeckEnergyOnlyToggle.checked;
				const newAutoCheckSupporter = autoCheckSupporterToggle.checked;
				const newAutoTrashTM = autoTrashTmToggle.checked;
				const newWeaknessDamage = weaknessDamageToggle.checked;
				const newForceRefetchDeck = forceRefetchDeckToggle.checked;
				const newActiveTheme = themeSelect.value;
				const newToolLimit = parseInt(toolLimitInput.value, 10) || 4;
				const newLanguage = languageSelect.value;

				const currentSettings = settingsRep.value || {};
				// Make sure to not include the old useCustomAppearance setting
				const { useCustomAppearance, ...restOfSettings } = currentSettings;

				settingsRep.value = {
					...restOfSettings,
					typeColorMap: newColorMap,
					hotkeys: newHotkeys,
					vstarEnabled: newVstarEnabled,
					autoRetreatToggle: newAutoRetreatToggle,
					autoPrizeTake: newAutoPrizeTake,
					lostZoneEnabled: newLostZoneEnabled,
					reverseCardDisplay: newReverseCardDisplay,
					showDeckEnergyOnly: newShowDeckEnergyOnly,
					autoCheckSupporter: newAutoCheckSupporter,
					autoTrashTM: newAutoTrashTM,
					weaknessDamage: newWeaknessDamage,
					activeTheme: newActiveTheme,
					toolLimit: newToolLimit,
					language: newLanguage,
					forceRefetchDeck: newForceRefetchDeck
				};

				// Save Game Time Settings
				const timeLimitValue = parseInt(timeLimitInput.value, 10);
				let newTimeLimit = 0;
				let newUseCountdown = false;

				if (timeLimitValue > 0) {
					newTimeLimit = timeLimitValue * 60;
					newUseCountdown = true;
				}

				gameTimeSettings.value = {
					limit: newTimeLimit,
					useCountdown: newUseCountdown
				};

				saveBtn.textContent = 'Saved!';
				updateAllLabels();
				setTimeout(() => {
					saveBtn.textContent = 'Save All Settings';
				}, 1500);
			});

			const versionSpan = document.getElementById('bundle-version');
			const bundleVersionRep = nodecg.Replicant('bundleVersion');
			const updateInfoRep = nodecg.Replicant('updateInfo');

			bundleVersionRep.on('change', (newVal) => {
				if (newVal && versionSpan) {
					versionSpan.textContent = newVal;
				}
			});

			updateInfoRep.on('change', (newVal) => {
				const notificationDiv = document.getElementById('update-notification');
				if (newVal && newVal.available) {
					const lang = settingsRep.value ? settingsRep.value.language : 'jp';
					let message = `ğŸ‰ New version available: <strong>${newVal.latest}</strong>. <a href="${newVal.url}" target="_blank" rel="noopener noreferrer">Click here to download</a>`;
					if (lang === 'jp') {
						message = `ğŸ‰ æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³: <strong>${newVal.latest}</strong>ã€‚ <a href="${newVal.url}" target="_blank" rel="noopener noreferrer">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰</a>`;
					} else if (lang === 'chs') {
						message = `ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬: <strong>${newVal.latest}</strong>ã€‚ ä¸‹è½½é“¾æ¥: <a href="https://pan.baidu.com/s/1TX3Z2CWegzJKBi-jeJ4NKg?pwd=mn49" target="_blank" rel="noopener noreferrer">ç™¾åº¦ç½‘ç›˜</a> <a href="https://pan.quark.cn/s/80c16eaef331" target="_blank" rel="noopener noreferrer">å¤¸å…‹ç½‘ç›˜</a>`;
					} else if (lang === 'cht') {
						message = `ğŸ‰ ç™¼ç¾æ–°ç‰ˆæœ¬: <strong>${newVal.latest}</strong>ã€‚ <a href="${newVal.url}" target="_blank" rel="noopener noreferrer">é»æ“Šæ­¤è™•ä¸‹è¼‰</a>`;
					}
					notificationDiv.innerHTML = message;
					notificationDiv.style.display = 'block';
				} else {
					notificationDiv.style.display = 'none';
				}
			});

			const supportBtn = document.getElementById('support-developer-btn');
			const donationModal = document.getElementById('donation-modal');
			const closeModalBtn = document.getElementById('donation-modal-close-btn');
			const donationModalTitle = document.getElementById('donation-modal-title-text');
			const donationContentArea = document.getElementById('donation-content-area');

			if (nodecg.bundleConfig && nodecg.bundleConfig.donation_links) {
				supportBtn.style.display = 'inline-block';
				const links = nodecg.bundleConfig.donation_links;
				supportBtn.addEventListener('click', () => {
					const lang = settingsRep.value ? settingsRep.value.language : 'jp';
					donationModalTitle.textContent = getI18nText('donation_modal_title');
					donationContentArea.innerHTML = '';
					switch (lang) {
						case 'chs':
							if (links.wechat_qr_url) donationContentArea.innerHTML += `<img class="qr-code-wechat" src="${links.wechat_qr_url}" alt="WeChat Pay">`;
							if (links.alipay_qr_url) donationContentArea.innerHTML += `<img class="qr-code-alipay" src="${links.alipay_qr_url}" alt="Alipay">`;
							break;
						case 'jp':
							if (links.ofuse_url) donationContentArea.innerHTML = `<a href="${links.ofuse_url}" target="_blank" rel="noopener noreferrer" class="ofuse-custom-btn">OFUSEã§å¿œæ´ã‚’é€ã‚‹</a>`;
							break;
						default:
							if (links.buy_me_a_coffee_url) donationContentArea.innerHTML = `<a href="${links.buy_me_a_coffee_url}" target="_blank" rel="noopener noreferrer"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a>`;
							break;
					}
					donationModal.style.display = 'block';
				});
				closeModalBtn.addEventListener('click', () => { donationModal.style.display = 'none'; });
				window.addEventListener('click', (event) => {
					if (event.target == donationModal) {
						donationModal.style.display = 'none';
					}
				});
			}
		});
	</script>
</body>

</html>