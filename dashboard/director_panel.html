<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Director Panel</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 15px;
            font-size: 14px;
        }
        .panel-section {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .panel-section h3 {
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            font-size: 16px;
            font-weight: 600;
            color: #555;
        }
        .btn {
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .btn:hover {
            background-color: #f5f5f5;
        }
        .btn-primary {
            background-color: #4a69bd;
            color: white;
            border-color: #4a69bd;
        }
        .btn-primary:hover {
            background-color: #3b5998;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-metal {
            background-color: #767880;
            color: white;
        }
        .form-group {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .form-group label {
            margin-right: 10px;
            font-weight: bold;
        }
        .operation-queue {
            height: 250px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
            overflow-y: auto;
            background-color: #fafafa;
            margin-bottom: 10px;
        }
        .operation-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 13px;
        }
        .operation-item:last-child {
            border-bottom: none;
        }
        .operation-item.selected {
            background-color: #d4e6ff;
        }
        .flex-container {
            display: flex;
            gap: 10px;
        }
        .flex-container > * {
            flex: 1;
        }
    </style>
</head>
<body>

    <div class="panel-section">
        <h3>Game Setup</h3>
        <div class="form-group" style="flex: 1; margin-bottom: 0;">
            <label for="first-player-select" data-i18n="first_move">First Move:</label>
            <select id="first-player-select">
                <option value="">--Select--</option>
                <option value="L">Left Player</option>
                <option value="R">Right Player</option>
            </select>
        </div>
    </div>
    
    <div class="panel-section">
        <div id="queue-manual-controls">
            <h3>Operation Queue</h3>
            <div id="op-buttons-container" class="flex-container" style="margin-bottom: 10px;">
                <button id="discard-op-btn" class="btn btn-danger">Discard (Esc)</button>
                <button id="apply-op-btn" class="btn btn-primary">Apply (Ctrl+S)</button>
            </div>
            <div class="operation-queue" id="operation-queue">
                <!-- Operations will be listed here -->
            </div>
        </div>
        <div id="auto-apply-warning" class="btn" style="display: none; width: 100%; box-sizing: border-box; font-weight: 800; color:#ff4040; background-color: black; pointer-events: none;">
            \\\\\\ WARNING: Auto-Apply Activated \\\\\\
        </div>
    </div>

    <div class="panel-section">
        <h3>Danger Zone</h3>
        <div class="flex-container" style="align-items: center;">
            <div class="form-group" style="flex-grow: 1; margin-bottom: 0; justify-content: center;">
                <input type="checkbox" id="auto-apply-checkbox" style="transform: scale(1.2); flex-grow: 0;">
                <label for="auto-apply-checkbox" style="margin-left: 5px;">Auto-Apply Live</label>
            </div>
            <button id="reset-system-btn" class="btn btn-danger" style="flex: 1;">Reset System</button>
        </div>
    </div>

    <script>
        NodeCG.waitForReplicants(
            nodecg.Replicant('operationQueue'),
            nodecg.Replicant('draft_currentTurn'),
            nodecg.Replicant('ptcg-settings'),
            nodecg.Replicant('playerL_name'),
            nodecg.Replicant('playerR_name'),
            nodecg.Replicant('cardDatabase'),
            nodecg.Replicant('firstMove'), // Added
            ...Array(18).fill(0).map((_, i) => { // Add all 18 slots
                const side = i < 9 ? 'L' : 'R';
                const index = i % 9;
                return nodecg.Replicant(`draft_slot${side}${index}`);
            })
        ).then(() => {
            // --- Replicant Setup ---
            const operationQueue = nodecg.Replicant('operationQueue');
            const draft_currentTurn = nodecg.Replicant('draft_currentTurn');
            const settingsRep = nodecg.Replicant('ptcg-settings');
            const playerL_name = nodecg.Replicant('playerL_name');
            const playerR_name = nodecg.Replicant('playerR_name');
            const cardDatabase = nodecg.Replicant('cardDatabase');
            const firstMove = nodecg.Replicant('firstMove'); // Added
            const slots = [];
            for (let i = 0; i < 9; i++) {
                slots.push(nodecg.Replicant(`draft_slotL${i}`));
                slots.push(nodecg.Replicant(`draft_slotR${i}`));
            }

            // --- DOM Element Setup ---
            const firstPlayerSelect = document.getElementById('first-player-select'); // Added
            const operationQueueEl = document.getElementById('operation-queue');
            const discardOpBtn = document.getElementById('discard-op-btn');
            const applyOpBtn = document.getElementById('apply-op-btn');
            const autoApplyWarning = document.getElementById('auto-apply-warning');
            const autoApplyCheckbox = document.getElementById('auto-apply-checkbox');
            const resetSystemBtn = document.getElementById('reset-system-btn');

            // --- Core Functions ---
            function queueOperation(type, payload) {
                nodecg.sendMessage('queueOperation', { type, payload })
                    .catch(e => console.error(`Failed to queue operation ${type}`, e));
            }

            function getCardName(slotId) {
                const db = cardDatabase.value;
                const slot = slots.find(s => s.name === `draft_${slotId}`);
                if (slot && slot.value && slot.value.cardId && db && db[slot.value.cardId]) {
                    return db[slot.value.cardId].name;
                }
                return slotId; // Fallback to slotId if name not found
            };

            function formatOperation(op) {
                const { type, payload } = op;
                const targetName = payload.target ? getCardName(payload.target) : '';

                switch (type) {
                    case 'SET_POKEMON':
                        return `<b>${payload.target}</b>: Set <b>${getCardName(payload.target)}</b>`;
                    case 'REPLACE_POKEMON':
                        return `<b>${targetName}</b>: ${payload.actionType} to <b>${getCardName(payload.target)}</b>`;
                    case 'SET_DAMAGE':
                        return `<b>${targetName}</b>: Set DMG to <b>${payload.value}</b>`;
                    case 'SET_EXTRA_HP':
                        return `<b>${targetName}</b>: Set Ex.HP to <b>${payload.value}</b>`;
                    case 'SET_TOOLS':
                        const toolNames = payload.tools.map(id => cardDatabase.value[id]?.name || 'Unknown').join(', ');
                        return `<b>${targetName}</b>: Set Tools to <b>[${toolNames}]</b>`;
                    case 'REMOVE_POKEMON':
                        return `<b>${targetName}</b>: Remove from play`;
                    case 'KO_POKEMON':
                        return `<b>${targetName}</b>: K.O.`;
                    case 'SET_AILMENTS':
                        return `<b>${targetName}</b>: Set Ailments to <b>[${payload.ailments.join(', ')}]</b>`;
                    case 'SET_ABILITY_USED':
                        return `<b>${targetName}</b>: Ability status set to <b>${payload.status}</b>`;
                    case 'SET_ENERGIES':
                        return `<b>${targetName}</b>: Set Energies (<b>${payload.energies.length} total</b>)`;
                    case 'SWITCH_POKEMON':
                        return `<b>${targetName}</b>: Switch to <b>${payload.target}</b>`;
                    case 'ATTACK':
                        const attackerName = getCardName(payload.attackerSlotId);
                        const targetNames = payload.targets && payload.targets.length > 0
                            ? payload.targets.map(getCardName).join(', ')
                            : null;

                        let description = `<b>${attackerName}</b> uses <b>${payload.attackName}</b>`;
                        if (targetNames) {
                            description += ` on <b>${targetNames}</b>`;
                        }
                        if (payload.damage > 0) {
                            description += ` for <b>${payload.damage}</b> DMG`;
                            if (payload.isWeakness) {
                                description += ` (Weakness)`;
                            }
                        }
                        return description;
                    case 'SET_TURN':
                        const turnPlayer = payload.side === 'L' ? (playerL_name.value || 'Left') : (playerR_name.value || 'Right');
                        return `<b>TURN</b>: Set turn to <b>${turnPlayer}</b>`;
                    case 'SET_ACTION_STATUS':
                        return `<b>${payload.target.replace('_', ' ')}</b>: Set to <b>${payload.status}</b>`;
                    case 'SET_SIDES':
                        return `<b>${payload.target}</b>: Set remaining to <b>${payload.value}</b>`;
                    case 'SET_STADIUM':
                        const stadiumName = payload.cardId ? cardDatabase.value[payload.cardId]?.name : 'None';
                        return `<b>STADIUM</b>: Set to <b>${stadiumName}</b>`;
                    default:
                        return `<b>${op.type}</b>: ${JSON.stringify(op.payload)}`;
                }
            }

            function updateFirstPlayerDropdown() {
                const lName = playerL_name.value || 'Left Player';
                const rName = playerR_name.value || 'Right Player';
                const currentValue = firstPlayerSelect.value;

                firstPlayerSelect.innerHTML = `
                    <option value="">--Select--</option>
                    <option value="L">${lName}</option>
                    <option value="R">${rName}</option>
                `;
                firstPlayerSelect.value = currentValue;
            }

            const renderQueue = () => {
                operationQueueEl.innerHTML = '';
                if (!operationQueue.value) return;
                operationQueue.value.forEach(op => {
                    const item = document.createElement('div');
                    item.classList.add('operation-item');
                    item.dataset.opId = op.id;
                    item.innerHTML = formatOperation(op);
                    operationQueueEl.appendChild(item);
                });
            };

            // --- Event Listeners ---
            firstPlayerSelect.addEventListener('change', (e) => {
                firstMove.value = e.target.value;
            });

            discardOpBtn.addEventListener('click', () => nodecg.sendMessage('discardQueue'));
            applyOpBtn.addEventListener('click', () => nodecg.sendMessage('applyQueue'));
            resetSystemBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to reset the entire system? This cannot be undone.')) {
                    nodecg.sendMessage('resetSystem');
                }
            });
            autoApplyCheckbox.addEventListener('change', (e) => {
                settingsRep.value.autoApply = e.target.checked;
            });

            // --- Replicant Listeners ---
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            let hotkeys = { discard: 'Escape', apply: isMac ? 'Meta+S' : 'Control+S' };

            operationQueue.on('change', renderQueue);
            
            draft_currentTurn.on('change', (newValue) => {
                // The turn radio buttons are gone, so this listener is now empty.
                // It can be removed if no other logic is added here.
            });

            firstMove.on('change', (newValue) => {
                firstPlayerSelect.value = newValue;
            });

            settingsRep.on('change', (newValue) => {
                const autoApply = !!newValue.autoApply;
                autoApplyCheckbox.checked = autoApply;

                const queueManualControls = document.getElementById('queue-manual-controls');
                autoApplyWarning.style.display = autoApply ? 'block' : 'none';
                queueManualControls.style.display = autoApply ? 'none' : 'block';

                // Update hotkeys from settings
                if (newValue && newValue.hotkeys) {
                    hotkeys.discard = newValue.hotkeys.discard || 'Escape';
                    hotkeys.apply = newValue.hotkeys.apply || (isMac ? 'Meta+S' : 'Control+S');
                } else {
                    hotkeys = { discard: 'Escape', apply: isMac ? 'Meta+S' : 'Control+S' };
                }
                // Update button labels with hotkeys
                discardOpBtn.textContent = `Discard (${hotkeys.discard})`;
                applyOpBtn.textContent = `Apply (${hotkeys.apply})`;
            });

            playerL_name.on('change', (newName) => {
                updateFirstPlayerDropdown();
            });

            playerR_name.on('change', (newName) => {
                updateFirstPlayerDropdown();
            });

            // Initial setup
            renderQueue();

            // --- Hotkey Logic ---
            function checkHotkey(e, hotkeyString) {
                if (!hotkeyString || typeof hotkeyString !== 'string') return false;
                if (hotkeyString.toLowerCase() === 'space' || hotkeyString === ' ') {
                    return e.key === ' ';
                }
                const parts = hotkeyString.toLowerCase().split('+').map(p => p.trim());
                const key = parts.pop();
                if (e.key.toLowerCase() !== key) return false;
                if (parts.includes('ctrl') !== e.ctrlKey) return false;
                if (parts.includes('alt') !== e.altKey) return false;
                if (parts.includes('shift') !== e.shiftKey) return false;
                if (parts.includes('meta') !== e.metaKey) return false;
                return true;
            }
            
            // Initial label update
            if (settingsRep.value && settingsRep.value.hotkeys) {
                hotkeys.discard = settingsRep.value.hotkeys.discard || 'Escape';
                hotkeys.apply = settingsRep.value.hotkeys.apply || (isMac ? 'Meta+S' : 'Control+S');
            }
            discardOpBtn.textContent = `Discard (${hotkeys.discard})`;
            applyOpBtn.textContent = `Apply (${hotkeys.apply})`;


            document.addEventListener('keydown', (e) => {
                // Ignore if typing in an input field
                if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'SELECT') return;
                
                const autoApplyEnabled = settingsRep.value && settingsRep.value.autoApply;

                if (checkHotkey(e, hotkeys.discard)) {
                    if (autoApplyEnabled) return;
                    e.preventDefault();
                    discardOpBtn.click();
                } else if (checkHotkey(e, hotkeys.apply)) {
                    if (autoApplyEnabled) return;
                    e.preventDefault();
                    applyOpBtn.click();
                }
            });

            // Listen for hotkey commands from other panels
            nodecg.listenFor('hotkeyFired', (command) => {
                if (command === 'discard') {
                    discardOpBtn.click();
                } else if (command === 'apply') {
                    applyOpBtn.click();
                }
            });
        });
    </script>
</body>
</html>