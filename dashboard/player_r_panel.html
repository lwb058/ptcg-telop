<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Player R Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Basic styling for the panel */
        body { font-family: sans-serif; background-color: #f0f2f5; color: #333; margin: 15px; font-size: 14px; transition: opacity 0.4s ease; }
        /* Style for when the panel is not the active turn */
        body.is-inactive {
            color: #9b9b9b;
            opacity: 0.6;
        }
        body.is-inactive:hover {
            color: #333; /* Restore color on hover for interaction */
            opacity: 1; /* Restore opacity on hover for interaction */
        }
        .panel-section { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .panel-section h3 { margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 16px; color: #555; }
        .form-group { margin-bottom: 10px; display: flex; align-items: center; }
        .form-group label { margin-right: 5px; font-weight: bold; white-space: nowrap; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; background-color: #fff; cursor: pointer; transition: background-color 0.2s; }
        .btn:hover { background-color: #f5f5f5; }
        .swap-btn { padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; background-color: #fff; cursor: pointer; transition: background-color 0.2s; }
        .swap-btn:hover { background-color: #f5f5f5; }
        .btn-danger { background-color: #e74c3c; color: white; border-color: #e74c3c; }
        .btn-danger:hover { background-color: #c0392b; }
        .flex-container { display: flex; gap: 10px; align-items: center; }
        /* Styling for each Pokemon slot */
        .pokemon-slot { border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin-bottom: 10px; }
        .pokemon-slot.selected {
            border: 2px solid #fd0d0d;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);
            /* Adjust padding to account for thicker border, maintaining inner size */
            padding: 9px;
        }
        .ability-icon {
            width: 84px;
            height: 16px;
            cursor: pointer;
            transition: filter 0.2s ease;
            filter: grayscale(0); /* Default: full color */
        }
        .ability-icon.used {
            filter: grayscale(1) brightness(0.4); /* Used: dark gray */
        }
        .pokemon-slot.battle-slot { border-color: #b234b3; padding-top: 5px; } /* Special border for the active battle slot */
        .pokemon-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; margin-bottom: 10px; }
        .pokemon-header .name-container { display: flex; align-items: center; gap: 8px; font-size: 1.2em; flex-grow: 1; }
        .ability-checkbox-wrapper { font-weight: normal; font-size: 0.9em; display: flex; align-items: center; gap: 4px; margin: 0 10px; }
        .pokemon-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1.5fr;
            gap: 5px;
            margin-bottom: 5px;
        }
        .pokemon-controls .form-group, .form-group {
            margin-bottom: 5px; /* A bit of space between rows */
        }
        .tool-energy-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .tool-energy-row .tool-wrapper {
            flex: 2;
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 0; /* Allow shrinking */
        }
        .tool-energy-row .energy-wrapper {
            flex: 3;
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 0; /* Allow shrinking */
        }
        .tool-select, .energy-container {
            width: 100%;
        }
        .energy-container {
            flex-wrap: nowrap; /* Prevent wrapping */
            overflow-x: auto; /* Enable horizontal scroll on overflow */
            scrollbar-width: thin; /* Firefox scrollbar styling */
            scrollbar-color: #ccc #f0f2f5;
        }
        /* Webkit (Chrome, Safari) scrollbar styling */
        .energy-container::-webkit-scrollbar { height: 5px; }
        .energy-container::-webkit-scrollbar-track { background: #f0f2f5; }
        .energy-container::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 2px; }

        .energy-container { border: 1px solid #ccc; border-radius: 4px; padding: 5px; min-height: 20px; display: flex; gap: 5px; background: #f9f9f9; }
        .energy-icon { width: 20px; height: 20px; cursor: pointer; flex-shrink: 0; /* Prevent icons from shrinking */ }
        .checkbox-group label { margin-right: 15px; font-weight: normal; }
        .player-action label {
            padding: 4px 10px;
            margin-right: 32px;
            font-weight: bolder;
            white-space: nowrap;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .ailment-icons, .bench-actions { display: flex; gap: 5px; align-items: center; }
        .ailment-icon { width: 30px; height: 30px; cursor: pointer; opacity: 0.3; transition: opacity 0.2s; }
        .ailment-icon.active { opacity: 1; }
        /* Styles for the collapsible Extra Bench section, copied from setting.html for consistency */
        details {
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: 10px;
        }
        summary {
            font-size: 16px;
            color: #555;
            font-weight: bold;
            padding-bottom: 10px;
            cursor: pointer;
            list-style: none;
            display: flex;
            align-items: center;
            user-select: none;
        }
        summary::-webkit-details-marker { display: none; }
        summary::before {
            content: '▶';
            margin-right: 8px;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
        [id^="toggle-extra-bench-"].btn-primary {
            background-color: #cce5ff; /* A light blue background */
            color: #004085; /* A dark blue text color */
            border-color: #b8daff;
        }
        /* Utility class to hide elements */
        .hidden { display: none; }

        .tool-display {
            flex-grow: 0;
            cursor: pointer;
            /* New styles for multi-tool */
            display: flex;
            gap: 4px;
            align-items: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 2px 5px;
            min-height: 42px; /* To match energy container feel */
            background: #f9f9f9;
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: #ccc #f0f2f5;
        }
        .tool-display::-webkit-scrollbar { height: 5px; }
        .tool-display::-webkit-scrollbar-track { background: #f0f2f5; }
        .tool-display::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 2px; }

        .tool-placeholder {
            border: 2px dashed #ccc;
            text-align: center;
            padding: 8px 6px;
            color: #aaa;
            font-size: 12px;
            line-height: 1.0;
            height: 100%;
            box-sizing: border-box;
        }
        .tool-icon-image {
            width: 48px; /* Change width to fixed */
            flex-shrink: 0; /* Prevent icons from shrinking */
            height: 33px;
            border-radius: 2px;
            border: 2px solid #888;
            background-size: 127%;
            background-position: center 21%;
            background-repeat: no-repeat;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <!-- ======================================================================= -->
    <!-- Player Info & Deck Section                                              -->
    <!-- ======================================================================= -->
    <div class="panel-section">

        <div class="form-group">
            <label for="deck-id-r">DeckID:</label>
            <input type="text" id="deck-id-r">
            <button id="set-deck-btn-r" class="btn" style="margin-left: 5px;">Set</button>
        </div>

        <div class="flex-container">
            <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
                <label for="player-name-r">Player:</label>
                <input type="text" id="player-name-r">
            </div>
            <div class="form-group hidden" id="vstar-container-r" style="flex-grow: 0; margin-bottom: 0; margin-left: 10px;">
                <label for="vstar-used-r">VSTAR</label>
                <input type="checkbox" id="vstar-used-r" style="transform: scale(1.5);">
            </div>
        </div>

        <div class="form-group checkbox-group" id="remain-side-r-container">
            <label>Side:</label>
            <!-- Radio buttons will be dynamically inserted here -->
        </div>
        <div class="form-group">
            <label for="lost-zone-r">Lost Zone:</label>
            <input type="number" id="lost-zone-r" value="0" min="0" step="1">
        </div>
    </div>

    <!-- ======================================================================= -->
    <!-- Pokemon Slots Container                                                 -->
    <!-- ======================================================================= -->
    <div id="pokemon-slots-container-r">
        
        <!-- SLOT 0 (Battle Slot) -->
        <div id="slot-R0" class="pokemon-slot battle-slot">
            <div class="pokemon-view hidden">
                <div class="pokemon-header">
                    <div class="name-container">
                        <label>
                            <input type="checkbox" class="selection-checkbox">
                            <span class="name"></span>
                        </label>
                    </div>
                    <div class="ability-checkbox-wrapper hidden"></div>
                    <div class="hp-remain"></div>
                </div>
                <div class="pokemon-controls">
                    <div class="form-group"><label>DMG:</label><input type="number" class="damage-input" value="0" step="10" min="0"></div>
                    <div class="form-group"><label>Ex.HP:</label><input type="number" class="extrahp-input" value="0" step="10"></div>
                    <div class="form-group"><label>Evo:</label><select class="evolution-select"><option value="">None</option></select></div>
                </div>
                <div class="form-group tool-energy-row">
                    <div class="tool-wrapper">
                        <label>Tool:</label>
                        <div class="tool-display" title="Click to remove tool"></div>
                    </div>
                    <div class="energy-wrapper">
                        <label>ENE:</label>
                        <div class="energy-container"></div>
                    </div>
                </div>
                <div class="actions">
                    <div class="dropdown">
                        <button class="btn dropdown-toggle swap-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            逃げ
                        </button>
                        <ul class="dropdown-menu swap-menu">
                            <!-- Menu items will be dynamically generated -->
                        </ul>
                    </div>
                    <div class="ailment-icons">
                        <img src="/assets/ptcg-telop/status/Poisoned.png" class="ailment-icon" data-ailment="Poisoned" title="Poisoned">
                        <img src="/assets/ptcg-telop/status/Burned.png" class="ailment-icon" data-ailment="Burned" title="Burned">
                        <img src="/assets/ptcg-telop/status/Asleep.png" class="ailment-icon" data-ailment="Asleep" title="Asleep">
                        <img src="/assets/ptcg-telop/status/Paralyzed.png" class="ailment-icon" data-ailment="Paralyzed" title="Paralyzed">
                        <img src="/assets/ptcg-telop/status/Confused.png" class="ailment-icon" data-ailment="Confused" title="Confused">
                    </div>
                    <div class="d-flex gap-2">
                        <label><input type="checkbox" class="ko-checkbox"> K.O</label>
                        <button class="btn btn-danger remove-btn">Remove</button>
                    </div>
                </div>
            </div>
            <div class="empty-view">
                <div class="form-group">
                    <label>BATTLE SLOT EMPTY</label>
                    <select class="empty-pokemon-select"><option value="">Select Pokemon</option></select>
                </div>
            </div>
        </div>
        <div class="form-group player-action">
            <label><input type="checkbox" id="action-energy-r"> ENERGY</label>
            <label><input type="checkbox" id="action-supporter-r"> SUPPORTER</label>
            <label><input type="checkbox" id="action-retreat-r"> RETREAT</label>
        </div>
        <!-- SLOT 1-5 (Bench Slots Template) -->
        <div id="slot-R1" class="pokemon-slot">
            <div class="pokemon-view hidden">
                 <div class="pokemon-header">
                    <div class="name-container">
                        <label>
                            <input type="checkbox" class="selection-checkbox">
                            <span class="name"></span>
                        </label>
                    </div>
                    <div class="ability-checkbox-wrapper hidden"></div>
                    <div class="hp-remain"></div>
                </div>
                <div class="pokemon-controls">
                    <div class="form-group"><label>DMG:</label><input type="number" class="damage-input" value="0" step="10" min="0"></div>
                    <div class="form-group"><label>Ex.HP:</label><input type="number" class="extrahp-input" value="0" step="10"></div>
                    <div class="form-group"><label>Evo:</label><select class="evolution-select"><option value="">None</option></select></div>
                </div>
                <div class="form-group tool-energy-row">
                    <div class="tool-wrapper">
                        <label>Tool:</label>
                        <div class="tool-display" title="Click to remove tool"></div>
                    </div>
                    <div class="energy-wrapper">
                        <label>ENE:</label>
                        <div class="energy-container"></div>
                    </div>
                </div>
                <div class="actions">
                    <div class="bench-actions">
                        <div class="dropdown">
                            <button class="btn dropdown-toggle swap-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                移動
                            </button>
                            <ul class="dropdown-menu swap-menu">
                                <!-- Menu items will be dynamically generated -->
                            </ul>
                        </div>
                    </div>
                    <div>
                        <label><input type="checkbox" class="ko-checkbox"> K.O</label>
                        <button class="btn btn-danger remove-btn">Remove</button>
                    </div>
                </div>
            </div>
            <div class="empty-view">
                <div class="form-group">
                    <label>EMPTY</label>
                    <select class="empty-pokemon-select"><option value="">Select Pokemon</option></select>
                </div>
            </div>
        </div>
        <div id="slot-R2" class="pokemon-slot">
            <div class="pokemon-view hidden">
                 <div class="pokemon-header">
                    <div class="name-container">
                        <label>
                            <input type="checkbox" class="selection-checkbox">
                            <span class="name"></span>
                        </label>
                    </div>
                    <div class="ability-checkbox-wrapper hidden"></div>
                    <div class="hp-remain"></div>
                </div>
                <div class="pokemon-controls">
                    <div class="form-group"><label>DMG:</label><input type="number" class="damage-input" value="0" step="10" min="0"></div>
                    <div class="form-group"><label>Ex.HP:</label><input type="number" class="extrahp-input" value="0" step="10"></div>
                    <div class="form-group"><label>Evo:</label><select class="evolution-select"><option value="">None</option></select></div>
                </div>
                <div class="form-group tool-energy-row">
                    <div class="tool-wrapper">
                        <label>Tool:</label>
                        <div class="tool-display" title="Click to remove tool"></div>
                    </div>
                    <div class="energy-wrapper">
                        <label>ENE:</label>
                        <div class="energy-container"></div>
                    </div>
                </div>
                <div class="actions">
                    <div class="bench-actions">
                        <div class="dropdown">
                            <button class="btn dropdown-toggle swap-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                移動
                            </button>
                            <ul class="dropdown-menu swap-menu">
                                <!-- Menu items will be dynamically generated -->
                            </ul>
                        </div>
                    </div>
                    <div>
                        <label><input type="checkbox" class="ko-checkbox"> K.O</label>
                        <button class="btn btn-danger remove-btn">Remove</button>
                    </div>
                </div>
            </div>
            <div class="empty-view">
                <div class="form-group">
                    <label>EMPTY</label>
                    <select class="empty-pokemon-select"><option value="">Select Pokemon</option></select>
                </div>
            </div>
        </div>
        <div id="slot-R3" class="pokemon-slot">
            <div class="pokemon-view hidden">
                 <div class="pokemon-header">
                    <div class="name-container">
                        <label>
                            <input type="checkbox" class="selection-checkbox">
                            <span class="name"></span>
                        </label>
                    </div>
                    <div class="ability-checkbox-wrapper hidden"></div>
                    <div class="hp-remain"></div>
                </div>
                <div class="pokemon-controls">
                    <div class="form-group"><label>DMG:</label><input type="number" class="damage-input" value="0" step="10" min="0"></div>
                    <div class="form-group"><label>Ex.HP:</label><input type="number" class="extrahp-input" value="0" step="10"></div>
                    <div class="form-group"><label>Evo:</label><select class="evolution-select"><option value="">None</option></select></div>
                </div>
                <div class="form-group tool-energy-row">
                    <div class="tool-wrapper">
                        <label>Tool:</label>
                        <div class="tool-display" title="Click to remove tool"></div>
                    </div>
                    <div class="energy-wrapper">
                        <label>ENE:</label>
                        <div class="energy-container"></div>
                    </div>
                </div>
                <div class="actions">
                    <div class="bench-actions">
                        <div class="dropdown">
                            <button class="btn dropdown-toggle swap-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                移動
                            </button>
                            <ul class="dropdown-menu swap-menu">
                                <!-- Menu items will be dynamically generated -->
                            </ul>
                        </div>
                    </div>
                    <div>
                        <label><input type="checkbox" class="ko-checkbox"> K.O</label>
                        <button class="btn btn-danger remove-btn">Remove</button>
                    </div>
                </div>
            </div>
            <div class="empty-view">
                <div class="form-group">
                    <label>EMPTY</label>
                    <select class="empty-pokemon-select"><option value="">Select Pokemon</option></select>
                </div>
            </div>
        </div>
        <div id="slot-R4" class="pokemon-slot">
            <div class="pokemon-view hidden">
                 <div class="pokemon-header">
                    <div class="name-container">
                        <label>
                            <input type="checkbox" class="selection-checkbox">
                            <span class="name"></span>
                        </label>
                    </div>
                    <div class="ability-checkbox-wrapper hidden"></div>
                    <div class="hp-remain"></div>
                </div>
                <div class="pokemon-controls">
                    <div class="form-group"><label>DMG:</label><input type="number" class="damage-input" value="0" step="10" min="0"></div>
                    <div class="form-group"><label>Ex.HP:</label><input type="number" class="extrahp-input" value="0" step="10"></div>
                    <div class="form-group"><label>Evo:</label><select class="evolution-select"><option value="">None</option></select></div>
                </div>
                <div class="form-group tool-energy-row">
                    <div class="tool-wrapper">
                        <label>Tool:</label>
                        <div class="tool-display" title="Click to remove tool"></div>
                    </div>
                    <div class="energy-wrapper">
                        <label>ENE:</label>
                        <div class="energy-container"></div>
                    </div>
                </div>
                <div class="actions">
                    <div class="bench-actions">
                        <div class="dropdown">
                            <button class="btn dropdown-toggle swap-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                移動
                            </button>
                            <ul class="dropdown-menu swap-menu">
                                <!-- Menu items will be dynamically generated -->
                            </ul>
                        </div>
                    </div>
                    <div>
                        <label><input type="checkbox" class="ko-checkbox"> K.O</label>
                        <button class="btn btn-danger remove-btn">Remove</button>
                    </div>
                </div>
            </div>
            <div class="empty-view">
                <div class="form-group">
                    <label>EMPTY</label>
                    <select class="empty-pokemon-select"><option value="">Select Pokemon</option></select>
                </div>
            </div>
        </div>
        <div id="slot-R5" class="pokemon-slot">
            <div class="pokemon-view hidden">
                 <div class="pokemon-header">
                    <div class="name-container">
                        <label>
                            <input type="checkbox" class="selection-checkbox">
                            <span class="name"></span>
                        </label>
                    </div>
                    <div class="ability-checkbox-wrapper hidden"></div>
                    <div class="hp-remain"></div>
                </div>
                <div class="pokemon-controls">
                    <div class="form-group"><label>DMG:</label><input type="number" class="damage-input" value="0" step="10" min="0"></div>
                    <div class="form-group"><label>Ex.HP:</label><input type="number" class="extrahp-input" value="0" step="10"></div>
                    <div class="form-group"><label>Evo:</label><select class="evolution-select"><option value="">None</option></select></div>
                </div>
                <div class="form-group tool-energy-row">
                    <div class="tool-wrapper">
                        <label>Tool:</label>
                        <div class="tool-display" title="Click to remove tool"></div>
                    </div>
                    <div class="energy-wrapper">
                        <label>ENE:</label>
                        <div class="energy-container"></div>
                    </div>
                </div>
                <div class="actions">
                    <div class="bench-actions">
                        <div class="dropdown">
                            <button class="btn dropdown-toggle swap-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                移動
                            </button>
                            <ul class="dropdown-menu swap-menu">
                                <!-- Menu items will be dynamically generated -->
                            </ul>
                        </div>
                    </div>
                    <div>
                        <label><input type="checkbox" class="ko-checkbox"> K.O</label>
                        <button class="btn btn-danger remove-btn">Remove</button>
                    </div>
                </div>
            </div>
            <div class="empty-view">
                <div class="form-group">
                    <label>EMPTY</label>
                    <select class="empty-pokemon-select"><option value="">Select Pokemon</option></select>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================================================================= -->
    <!-- Extra Bench Section                                                     -->
    <!-- ======================================================================= -->
    <div class="panel-section">
        <details>
            <summary>Extra Bench <button id="toggle-extra-bench-r" class="btn" style="margin-left: auto;">Show</button></summary>
            <div id="extra-bench-container-r" style="padding-top: 10px;">
                <!-- SLOT 6-8 (Extra Bench Slots) -->
                <div id="slot-R6" class="pokemon-slot">
                    <div class="pokemon-view hidden">
                        <div class="pokemon-header">
                            <div class="name-container">
                        <label>
                            <input type="checkbox" class="selection-checkbox">
                            <span class="name"></span>
                        </label>
                            </div>
                            <div class="ability-checkbox-wrapper hidden"></div>
                            <div class="hp-remain"></div>
                        </div>
                        <div class="pokemon-controls">
                            <div class="form-group"><label>DMG:</label><input type="number" class="damage-input" value="0" step="10" min="0"></div>
                            <div class="form-group"><label>Ex.HP:</label><input type="number" class="extrahp-input" value="0" step="10"></div>
                            <div class="form-group"><label>Evo:</label><select class="evolution-select"><option value="">None</option></select></div>
                        </div>
                        <div class="form-group tool-energy-row">
                            <div class="tool-wrapper">
                                <label>Tool:</label>
                                <div class="tool-display" title="Click to remove tool"></div>
                            </div>
                            <div class="energy-wrapper">
                                <label>ENE:</label>
                                <div class="energy-container"></div>
                            </div>
                        </div>
                        <div class="actions">
                            <div class="bench-actions">
                                <div class="dropdown">
                            <button class="btn dropdown-toggle swap-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                移動
                            </button>
                            <ul class="dropdown-menu swap-menu">
                                <!-- Menu items will be dynamically generated -->
                            </ul>
                        </div>
                            </div>
                            <div>
                                <label><input type="checkbox" class="ko-checkbox"> K.O</label>
                                <button class="btn btn-danger remove-btn">Remove</button>
                            </div>
                        </div>
                    </div>
                    <div class="empty-view">
                        <div class="form-group">
                            <label>EMPTY</label>
                            <select class="empty-pokemon-select"><option value="">Select Pokemon</option></select>
                        </div>
                    </div>
                </div>
                <div id="slot-R7" class="pokemon-slot">
                    <div class="pokemon-view hidden">
                        <div class="pokemon-header">
                            <div class="name-container">
                                <label>
                                    <input type="checkbox" class="selection-checkbox">
                                    <span class="name"></span>
                                </label>
                            </div>
                            <div class="ability-checkbox-wrapper hidden"></div>
                            <div class="hp-remain"></div>
                        </div>
                        <div class="pokemon-controls">
                            <div class="form-group"><label>DMG:</label><input type="number" class="damage-input" value="0" step="10" min="0"></div>
                            <div class="form-group"><label>Ex.HP:</label><input type="number" class="extrahp-input" value="0" step="10"></div>
                            <div class="form-group"><label>Evo:</label><select class="evolution-select"><option value="">None</option></select></div>
                        </div>
                        <div class="form-group tool-energy-row">
                            <div class="tool-wrapper">
                                <label>Tool:</label>
                                <div class="tool-display" title="Click to remove tool"></div>
                            </div>
                            <div class="energy-wrapper">
                                <label>ENE:</label>
                                <div class="energy-container"></div>
                            </div>
                        </div>
                        <div class="actions">
                            <div class="bench-actions">
                                <div class="dropdown">
                            <button class="btn dropdown-toggle swap-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                移動
                            </button>
                            <ul class="dropdown-menu swap-menu">
                                <!-- Menu items will be dynamically generated -->
                            </ul>
                        </div>
                            </div>
                            <div>
                                <label><input type="checkbox" class="ko-checkbox"> K.O</label>
                                <button class="btn btn-danger remove-btn">Remove</button>
                            </div>
                        </div>
                    </div>
                    <div class="empty-view">
                        <div class="form-group">
                            <label>EMPTY</label>
                            <select class="empty-pokemon-select"><option value="">Select Pokemon</option></select>
                        </div>
                    </div>
                </div>
                <div id="slot-R8" class="pokemon-slot">
                    <div class="pokemon-view hidden">
                        <div class="pokemon-header">
                            <div class="name-container">
                                <label>
                                    <input type="checkbox" class="selection-checkbox">
                                    <span class="name"></span>
                                </label>
                            </div>
                            <div class="ability-checkbox-wrapper hidden"></div>
                            <div class="hp-remain"></div>
                        </div>
                        <div class="pokemon-controls">
                            <div class="form-group"><label>DMG:</label><input type="number" class="damage-input" value="0" step="10" min="0"></div>
                            <div class="form-group"><label>Ex.HP:</label><input type="number" class="extrahp-input" value="0" step="10"></div>
                            <div class="form-group"><label>Evo:</label><select class="evolution-select"><option value="">None</option></select></div>
                        </div>
                        <div class="form-group tool-energy-row">
                            <div class="tool-wrapper">
                                <label>Tool:</label>
                                <div class="tool-display" title="Click to remove tool"></div>
                            </div>
                            <div class="energy-wrapper">
                                <label>ENE:</label>
                                <div class="energy-container"></div>
                            </div>
                        </div>
                        <div class="actions">
                            <div class="bench-actions">
                                <div class="dropdown">
                            <button class="btn dropdown-toggle swap-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                移動
                            </button>
                            <ul class="dropdown-menu swap-menu">
                                <!-- Menu items will be dynamically generated -->
                            </ul>
                        </div>
                            </div>
                            <div>
                                <label><input type="checkbox" class="ko-checkbox"> K.O</label>
                                <button class="btn btn-danger remove-btn">Remove</button>
                            </div>
                        </div>
                    </div>
                    <div class="empty-view">
                        <div class="form-group">
                            <label>EMPTY</label>
                            <select class="empty-pokemon-select"><option value="">Select Pokemon</option></select>
                        </div>
                    </div>
                </div>
            </div>
        </details>
    </div>

    <script>
        /**
         * This script manages the control panel for Player R.
         * - Listens to 'draft_' Replicants to provide instant UI feedback.
         * - All actions generate commands sent to the backend queue.
         * - Binds two-way with the 'selections' Replicant.
         */
        NodeCG.waitForReplicants(
            nodecg.Replicant('playerR_name'),
            nodecg.Replicant('deckIdR'),
            nodecg.Replicant('deckR'),
            nodecg.Replicant('cardDatabase'),
            nodecg.Replicant('selections'),
            nodecg.Replicant('operationQueue'),
            nodecg.Replicant('draft_currentTurn'),
            nodecg.Replicant('draft_action_energy_R'),
            nodecg.Replicant('draft_action_supporter_R'),
            nodecg.Replicant('draft_action_retreat_R'),
            nodecg.Replicant('draft_sideR'),
            nodecg.Replicant('draft_lostZoneR'),
            nodecg.Replicant('ptcg-settings'),
            nodecg.Replicant('draft_vstar_R'),
            ...Array(9).fill(0).map((_, i) => nodecg.Replicant(`draft_slotR${i}`))
        ).then(() => {
            // --- Replicants ---
            const playerR_name = nodecg.Replicant('playerR_name');
            const deckIdR = nodecg.Replicant('deckIdR');
            const draft_sideR = nodecg.Replicant('draft_sideR');
            const draft_lostZoneR = nodecg.Replicant('draft_lostZoneR');
            const deckR = nodecg.Replicant('deckR');
            const cardDatabase = nodecg.Replicant('cardDatabase');
            const selections = nodecg.Replicant('selections');
            const operationQueue = nodecg.Replicant('operationQueue');
            const draft_currentTurn = nodecg.Replicant('draft_currentTurn');
            const draft_action_energy_R = nodecg.Replicant('draft_action_energy_R');
            const draft_action_supporter_R = nodecg.Replicant('draft_action_supporter_R');
            const draft_action_retreat_R = nodecg.Replicant('draft_action_retreat_R');
            const settingsRep = nodecg.Replicant('ptcg-settings');
            const draft_vstar_R = nodecg.Replicant('draft_vstar_R');

            // --- DOM Elements ---
            const playerNameInput = document.getElementById('player-name-r');
            const deckIdInput = document.getElementById('deck-id-r');
            const setDeckBtn = document.getElementById('set-deck-btn-r');
            const energyCheck = document.getElementById('action-energy-r');
            const supporterCheck = document.getElementById('action-supporter-r');
            const retreatCheck = document.getElementById('action-retreat-r');
            const remainSideContainer = document.getElementById('remain-side-r-container');
            const vstarContainer = document.getElementById('vstar-container-r');
            const vstarCheckbox = document.getElementById('vstar-used-r');
            const lostZoneInput = document.getElementById('lost-zone-r');
            const pokemonSlotsContainer = document.getElementById('pokemon-slots-container-r');
            const extraBenchContainer = document.getElementById('extra-bench-container-r');
            const toggleExtraBenchBtn = document.getElementById('toggle-extra-bench-r');

            const extraBenchVisible = nodecg.Replicant('extraBenchVisible');
            const renderSlotDebounce = {};

            // --- Extra Bench Toggle --- 
            extraBenchVisible.on('change', (newValue) => {
                const isVisible = newValue ? newValue.right : false;
                toggleExtraBenchBtn.textContent = isVisible ? 'Hide' : 'Show';
                toggleExtraBenchBtn.classList.toggle('btn-primary', isVisible);
            });

            toggleExtraBenchBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const currentVisibility = extraBenchVisible.value || { left: false, right: false };
                extraBenchVisible.value = {
                    ...currentVisibility,
                    right: !currentVisibility.right
                };
            });


            // --- Turn Highlight Logic ---
            function updateTurnHighlight(currentTurn) {
                // If it's not player R's turn, add the 'is-inactive' class to dim the panel.
                document.body.classList.toggle('is-inactive', currentTurn !== 'R');
            }
            draft_currentTurn.on('change', updateTurnHighlight);
            updateTurnHighlight(draft_currentTurn.value); // Initial call

            /**
             * Converts a hex color code and an opacity value to an RGBA string.
             * @param {string} hex - The hex color code (e.g., "#RRGGBB").
             * @param {number} alpha - The opacity (0.0 to 1.0).
             * @returns {string} The RGBA color string, or an empty string if hex is invalid.
             */
            function hexToRgba(hex, alpha = 1.0) {
                if (!/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)) {
                    return '';
                }
                let c = hex.substring(1).split('');
                if (c.length === 3) {
                    c = [c[0], c[0], c[1], c[1], c[2], c[2]];
                }
                c = '0x' + c.join('');
                const r = (c >> 16) & 255;
                const g = (c >> 8) & 255;
                const b = c & 255;
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }

            // --- Side Area Management ---
            function renderSideButtons(remaining) {
                const label = remainSideContainer.querySelector('label');
                remainSideContainer.innerHTML = '';
                remainSideContainer.appendChild(label);

                for (let i = 6; i >= 0; i--) {
                    const wrapper = document.createElement('label');
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'remain-side-r';
                    radio.value = i;
                    if (i === remaining) {
                        radio.checked = true;
                    }
                    radio.addEventListener('change', () => {
                        queueOrUpdateOperation('SET_SIDES', { 
                            target: 'sideR', 
                            value: parseInt(radio.value, 10) 
                        });
                    });
                    wrapper.appendChild(radio);
                    wrapper.appendChild(document.createTextNode(` ${i}`));
                    remainSideContainer.appendChild(wrapper);
                }
            }

            draft_sideR.on('change', (newValue) => {
                renderSideButtons(newValue);
            });

            draft_lostZoneR.on('change', (newValue) => {
                lostZoneInput.value = newValue;
            });

            // --- Player Name Management ---
            playerR_name.on('change', (newName) => {
                if (playerNameInput.value !== newName) {
                    playerNameInput.value = newName || '';
                }
            });

            deckIdR.on('change', (newId) => {
                if (deckIdInput.value !== newId) {
                    deckIdInput.value = newId || '';
                }
            });

            playerNameInput.addEventListener('change', () => {
                playerR_name.value = playerNameInput.value;
            });

            lostZoneInput.addEventListener('change', () => {
                queueOrUpdateOperation('SET_LOST_ZONE', { 
                    target: 'lostZoneR', 
                    value: parseInt(lostZoneInput.value, 10) || 0 
                });
            });

            // --- VSTAR Management ---
            settingsRep.on('change', (newVal) => {
                const vstarContainer = document.getElementById('vstar-container-r');
                if (newVal && newVal.vstarEnabled) {
                    vstarContainer.classList.remove('hidden');
                } else {
                    vstarContainer.classList.add('hidden');
                }

                const lostZoneContainer = document.getElementById('lost-zone-r').parentElement;
                if (newVal && newVal.lostZoneEnabled) {
                    lostZoneContainer.classList.remove('hidden');
                } else {
                    lostZoneContainer.classList.add('hidden');
                }
            });

            draft_vstar_R.on('change', (newVal) => {
                vstarCheckbox.checked = newVal;
            });

            vstarCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                // Use the new, unified payload format
                queueOrUpdateOperation('SET_VSTAR_STATUS', {
                    target: 'vstar_R', // Unified target name
                    used: isChecked      // The value being set
                });
            });


            // --- Action Status Management (Independent Replicants) ---
            // Each checkbox now controls its own independent replicant.

            // Helper function to create a handler for a specific action type.
            const createActionHandler = (replicant, actionType) => {
                return (event) => {
                    const isChecked = event.target.checked;
                    // The payload is now simpler, directly reflecting the single action.
                    queueOrUpdateOperation('SET_ACTION_STATUS', { 
                        target: `action_${actionType}_R`, // Unique target for this action
                        status: isChecked 
                    });
                };
            };

            // Listen for changes on each individual replicant to update the UI.
            draft_action_energy_R.on('change', (newVal) => { energyCheck.checked = newVal; });
            draft_action_supporter_R.on('change', (newVal) => { supporterCheck.checked = newVal; });
            draft_action_retreat_R.on('change', (newVal) => { retreatCheck.checked = newVal; });

            // Attach the specific event listener to each checkbox.
            energyCheck.addEventListener('change', createActionHandler(draft_action_energy_R, 'energy'));
            supporterCheck.addEventListener('change', createActionHandler(draft_action_supporter_R, 'supporter'));
            retreatCheck.addEventListener('change', createActionHandler(draft_action_retreat_R, 'retreat'));

            /**
             * Sends an operation to the backend to be added to the queue.
             * @param {string} type - The type of the operation (e.g., 'SET_DAMAGE').
             * @param {object} payload - The data associated with the operation.
             */
            function queueOperation(type, payload) {
                nodecg.sendMessage('queueOperation', { type, payload })
                    .catch(e => console.error(`Failed to queue operation ${type}`, e));
            }

            /**
             * For operations that set a numeric value (like damage or HP), this function checks if an operation
             * of the same type for the same target already exists in the queue. If it exists, it updates the
             * existing operation; otherwise, it adds a new one.
             * @param {string} type - The operation type.
             * @param {object} payload - The operation data, which must include a 'target' property.
             */
            function queueOrUpdateOperation(type, payload) {
                const queue = operationQueue.value;
                if (Array.isArray(queue)) {
                    const existingOpIndex = queue.findIndex(op =>
                        op.type === type &&
                        op.payload.target === payload.target
                    );

                    if (existingOpIndex > -1) {
                        // If an existing operation is found, send an update message
                        nodecg.sendMessage('updateOperation', { index: existingOpIndex, payload })
                            .catch(e => console.error(`Failed to update operation ${type}`, e));
                        return;
                    }
                }
                // Otherwise, queue a new operation
                queueOperation(type, payload);
            }

            setDeckBtn.addEventListener('click', () => {
                const deckCode = deckIdInput.value.trim();
                if (!deckCode) return alert('Please enter a Deck ID.');
                deckIdR.value = deckCode;
                setDeckBtn.textContent = 'Loading...';
                setDeckBtn.disabled = true;
                nodecg.sendMessage('setPlayerDeck', { side: 'R', deckCode })
                    .finally(() => {
                        setDeckBtn.textContent = 'Set';
                        setDeckBtn.disabled = false;
                    });
            });

            function renderSlot(index, slotData, deck, db) {
                const slotEl = document.getElementById(`slot-R${index}`);
                if (!slotEl) return;

                slotEl.style.backgroundColor = ''; // Always reset background color

                const pokemonView = slotEl.querySelector('.pokemon-view');
                const emptyView = slotEl.querySelector('.empty-view');

                if (!slotData || !slotData.cardId) {
                    pokemonView.classList.add('hidden');
                    emptyView.classList.remove('hidden');
                    return;
                }

                emptyView.classList.add('hidden');
                pokemonView.classList.remove('hidden');

                const cardInfo = db[slotData.cardId];
                const typeColorMap = settingsRep.value?.typeColorMap || {};

                // Set background color based on type, supporting new {color, opacity} format
                if (cardInfo && cardInfo.pokemon && cardInfo.pokemon.color && cardInfo.pokemon.color.length > 0) {
                    const primaryType = cardInfo.pokemon.color[0];
                    const colorSetting = typeColorMap[primaryType];
                    
                    if (colorSetting) {
                        let finalColor = '';
                        if (typeof colorSetting === 'string') {
                            // Handle old format (just a hex string)
                            finalColor = hexToRgba(colorSetting, 1.0);
                        } else if (typeof colorSetting === 'object' && colorSetting.color) {
                            // Handle new format { color, opacity }
                            finalColor = hexToRgba(colorSetting.color, colorSetting.opacity);
                        }
                        
                        if (finalColor) {
                            slotEl.style.backgroundColor = finalColor;
                        }
                    }
                }
                
                if (!cardInfo || !cardInfo.pokemon) {
                    pokemonView.querySelector('.name').textContent = 'Error: Invalid Card Data';
                    return;
                }

                pokemonView.querySelector('.name').textContent = cardInfo.name || 'Unknown Name';
                const baseHp = parseInt(cardInfo.pokemon.hp || 0, 10);
                const extraHp = parseInt(slotData.extraHp || 0, 10);
                const damage = parseInt(slotData.damage || 0, 10);
                const currentHp = (baseHp + extraHp) - damage;
                pokemonView.querySelector('.hp-remain').textContent = `HP: ${currentHp}`;

                // The K.O. checkbox is now driven by the replicant state.
                const koCheckbox = pokemonView.querySelector('.ko-checkbox');
                koCheckbox.checked = slotData.isKO || false;

                // --- Ability Checkbox Logic ---
                const abilityCheckboxWrapper = pokemonView.querySelector('.ability-checkbox-wrapper');
                const hasAbility = cardInfo.pokemon.abilities && cardInfo.pokemon.abilities.length > 0;

                if (hasAbility) {
                    abilityCheckboxWrapper.classList.remove('hidden'); // Show the container
                    abilityCheckboxWrapper.innerHTML = `<img src="/assets/ptcg-telop/element/ability_mark.png" class="ability-icon ${slotData.abilityUsed ? 'used' : ''}" title="Toggle Ability Used">`;
                } else {
                    // Ensure the container is hidden when there is no ability.
                    abilityCheckboxWrapper.innerHTML = '';
                    abilityCheckboxWrapper.classList.add('hidden');
                }
                
                pokemonView.querySelector('.damage-input').value = slotData.damage || 0;
                pokemonView.querySelector('.extrahp-input').value = slotData.extraHp || 0;
                
                const toolDisplay = pokemonView.querySelector('.tool-display');
                if (toolDisplay) {
                    // Robustly clear the container
                    while (toolDisplay.firstChild) {
                        toolDisplay.removeChild(toolDisplay.firstChild);
                    }

                    const attachedTools = slotData.attachedToolIds || [];

                    if (attachedTools.length > 0) {
                        attachedTools.forEach(toolId => {
                            if (db && db[toolId]) {
                                const toolData = db[toolId];
                                const toolIconDiv = document.createElement('div');
                                toolIconDiv.title = `[${toolData.name}] - Click to remove`;
                                toolIconDiv.className = 'tool-icon-image';
                                toolIconDiv.style.backgroundImage = `url('/assets/ptcg-telop/card_img/${toolId}.jpg')`;
                                toolIconDiv.dataset.toolId = toolId;
                                toolDisplay.appendChild(toolIconDiv);
                            }
                        });
                    } else {
                        const placeholder = document.createElement('div');
                        placeholder.className = 'tool-placeholder';
                        placeholder.textContent = 'Empty';
                        toolDisplay.appendChild(placeholder);
                    }
                }

                const evolutionSelect = pokemonView.querySelector('.evolution-select');
                // Clear and rebuild the dropdown list
                evolutionSelect.innerHTML = '<option value="">Select...</option>';

                if (deck && deck.cards && db && cardInfo.pokemon) {
                    const currentCardName = cardInfo.name;
                    const currentCardId = slotData.cardId;
                    const currentCardEvolvesFrom = cardInfo.pokemon.evolvesFrom || [];

                    // 1. Filter all Pokémon from the deck (excluding self)
                    const allPokemonInDeck = deck.cards
                        .map(cardId => ({ id: cardId, data: db[cardId] }))
                        .filter(item => item.data && item.data.pokemon && item.data.pokemon.hp && item.id !== currentCardId);

                    // 2. Categorize
                    const evolutions = allPokemonInDeck.filter(item => item.data.pokemon.evolvesFrom?.includes(currentCardName));
                    const devolutions = allPokemonInDeck.filter(item => currentCardEvolvesFrom.includes(item.data.name));
                    
                    const evolutionIds = evolutions.map(p => p.id);
                    const devolutionIds = devolutions.map(p => p.id);
                    const others = allPokemonInDeck.filter(item => !evolutionIds.includes(item.id) && !devolutionIds.includes(item.id));

                    // 3. Dynamically create and add options
                    const addOptionsToSelect = (groupLabel, items, actionType) => {
                        if (items.length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = groupLabel;
                            items.forEach(item => {
                                const option = document.createElement('option');
                                option.value = item.id;
                                option.textContent = item.data.name;
                                option.dataset.actionType = actionType; // Attach action type
                                optgroup.appendChild(option);
                            });
                            evolutionSelect.appendChild(optgroup);
                        }
                    };

                    addOptionsToSelect('-進化-', evolutions, 'Evolve');
                    addOptionsToSelect('-退化-', devolutions, 'Devolve');
                    addOptionsToSelect('-入替-', others, 'Replace');
                }

                const energyContainer = pokemonView.querySelector('.energy-container');
                energyContainer.innerHTML = '';
                if (slotData.attachedEnergy) {
                    slotData.attachedEnergy.forEach((energyType, energyIndex) => {
                        const energyImg = document.createElement('img');
                        energyImg.src = `/assets/ptcg-telop/energy/${energyType}.png`;
                        energyImg.classList.add('energy-icon');
                        energyImg.title = `Click to remove ${energyType}`;
                        energyImg.addEventListener('click', () => {
                            // Create a copy of the current energy array
                            const currentEnergies = [...(slotData.attachedEnergy || [])];
                            // Remove the clicked energy from the copy
                            currentEnergies.splice(energyIndex, 1);
                            // Use the new energy array to set the final state via queueOrUpdate
                            queueOrUpdateOperation('SET_ENERGIES', { 
                                target: `slotR${index}`, 
                                energies: currentEnergies 
                            });
                        });
                        energyContainer.appendChild(energyImg);
                    });
                }

                if (index === 0) {
                    const ailmentIcons = pokemonView.querySelectorAll('.ailment-icon');
                    const currentAilments = slotData.ailments || [];
                    ailmentIcons.forEach(icon => {
                        const ailment = icon.dataset.ailment;
                        if (currentAilments.includes(ailment)) {
                            icon.classList.add('active');
                        } else {
                            icon.classList.remove('active');
                        }
                    });
                }

                const selectionCheckbox = pokemonView.querySelector('.selection-checkbox');
                selectionCheckbox.checked = selections.value.includes(`slotR${index}`);
            }

            function setupSlotEventListeners(index) {
                const slotEl = document.getElementById(`slot-R${index}`);
                const slotId = `slotR${index}`;

                slotEl.querySelector('.empty-pokemon-select').addEventListener('change', (e) => {
                    const newCardId = e.target.value;
                    if (newCardId) {
                        queueOperation('SET_POKEMON', { target: slotId, cardId: newCardId });
                        e.target.value = "";
                    }
                });

                const pokemonView = slotEl.querySelector('.pokemon-view');
                
                pokemonView.querySelector('.damage-input').addEventListener('change', (e) => {
                    queueOrUpdateOperation('SET_DAMAGE', { target: slotId, value: parseInt(e.target.value, 10) || 0 });
                });

                pokemonView.querySelector('.extrahp-input').addEventListener('change', (e) => {
                    queueOrUpdateOperation('SET_EXTRA_HP', { target: slotId, value: parseInt(e.target.value, 10) || 0 });
                });

                pokemonView.querySelector('.ability-checkbox-wrapper').addEventListener('click', (e) => {
                    const abilityIcon = e.currentTarget.querySelector('.ability-icon');
                    if (!abilityIcon) return; // Guard against clicks on empty wrappers

                    const currentStatus = abilityIcon.classList.contains('used');
                    const newStatus = !currentStatus;

                    queueOrUpdateOperation('SET_ABILITY_USED', { target: slotId, status: newStatus });
                });

                const toolDisplay = pokemonView.querySelector('.tool-display');
                if (toolDisplay) {
                    toolDisplay.addEventListener('click', (e) => {
                        const clickedIcon = e.target.closest('.tool-icon-image');
                        if (clickedIcon) {
                            const toolIdToRemove = clickedIcon.dataset.toolId;
                            if (toolIdToRemove) {
                                const slotReplicant = nodecg.Replicant(`draft_${slotId}`);
                                const currentTools = slotReplicant.value.attachedToolIds || [];
                                const indexToRemove = currentTools.indexOf(toolIdToRemove);

                                if (indexToRemove > -1) {
                                    const newTools = [...currentTools];
                                    newTools.splice(indexToRemove, 1);
                                    queueOrUpdateOperation('SET_TOOLS', { 
                                        target: slotId, 
                                        tools: newTools 
                                    });
                                }
                            }
                        }
                    });
                }


                pokemonView.querySelector('.evolution-select').addEventListener('change', (e) => {

                    const select = e.target;
                    const newCardId = select.value;
                    if (newCardId) {
                        const selectedOption = select.options[select.selectedIndex];
                        const actionType = selectedOption.dataset.actionType;
                        
                        // Use the new unified operation type
                        queueOperation('REPLACE_POKEMON', { 
                            target: slotId, 
                            cardId: newCardId,
                            actionType: actionType
                        });
                        
                        // When a Pokemon is evolved/replaced, its ability usage for the turn should be reset.
                        queueOrUpdateOperation('SET_ABILITY_USED', { target: slotId, status: false });

                        // Reset the dropdown to prevent accidental operations
                        select.value = "";
                    }
                });

                pokemonView.querySelector('.remove-btn').addEventListener('click', () => {
                    const slotReplicant = nodecg.Replicant(`draft_${slotId}`);
                    if (slotReplicant.value && slotReplicant.value.isKO) {
                        queueOperation('KO_POKEMON', { target: slotId });
                    } else {
                        queueOperation('REMOVE_POKEMON', { target: slotId });
                    }
                });

                // The K.O. checkbox now queues an operation to update the draft state.
                const koCheckbox = pokemonView.querySelector('.ko-checkbox');
                koCheckbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    queueOrUpdateOperation('SET_KO_STATUS', { target: slotId, status: isChecked });
                });

                // REMOVED OLD PROMOTE BTN LOGIC
                // if (index > 0) {
                //     const promoteBtn = pokemonView.querySelector('.promote-btn');
                //     if(promoteBtn) {
                //         promoteBtn.addEventListener('click', () => queueOperation('SWITCH_POKEMON', { target: slotId }));
                //     }
                // }

                if (index === 0) { // Battle Slot Specific Listeners
                    const ailmentIcons = pokemonView.querySelectorAll('.ailment-icon');
                    ailmentIcons.forEach(icon => {
                        icon.addEventListener('click', () => {
                            const slotReplicant = nodecg.Replicant(`draft_slotR${index}`);
                            const currentAilments = [...(slotReplicant.value.ailments || [])];
                            const ailment = icon.dataset.ailment;
                            const ailmentIndex = currentAilments.indexOf(ailment);

                            if (ailmentIndex > -1) {
                                currentAilments.splice(ailmentIndex, 1);
                            } else {
                                currentAilments.push(ailment);
                            }
                            queueOrUpdateOperation('SET_AILMENTS', { target: slotId, ailments: currentAilments });
                        });
                    });
                }

                const selectionCheckbox = slotEl.querySelector('.selection-checkbox');
                selectionCheckbox.addEventListener('change', (e) => {
                    const currentSelections = selections.value ? [...selections.value] : [];
                    const isChecked = e.target.checked;
                    const itemIndex = currentSelections.indexOf(slotId);
                    if (isChecked && itemIndex === -1) {
                        currentSelections.push(slotId);
                    } else if (!isChecked && itemIndex > -1) {
                        currentSelections.splice(itemIndex, 1);
                    }
                    selections.value = currentSelections;
                });
            }

            /**
             * Populates all empty Pokémon dropdowns with data from the deck.
             * Called when the deck or database changes.
             */
            function updateAllEmptySlotDropdowns() {
                const deck = deckR.value;
                const db = cardDatabase.value;
                if (!deck || !deck.cards || !db || Object.keys(db).length === 0) return;

                const pokemonInDeck = deck.cards
                    .map(cardId => ({ id: cardId, data: db[cardId] }))
                    // Filter by directly checking for a 'pokemon' object instead of 'supertype',
                    // this is to correctly handle special cases like Fossil cards, which are 'Trainer' cards but can be played as Basic Pokémon.
                    .filter(item => item.data && item.data.pokemon && item.data.pokemon.hp);

                // 1. Sorting rules:
                //    - Pokémon with "evolves" property of "たね" (Basic) are listed first.
                //    - On top of that, sort by HP in ascending order (low to high).
                pokemonInDeck.sort((a, b) => {
                    const isBasicA = a.data.pokemon.evolves === 'たね';
                    const isBasicB = b.data.pokemon.evolves === 'たね';

                    if (isBasicA && !isBasicB) {
                        return -1; // 'a' is Basic, so it comes first
                    }
                    if (!isBasicA && isBasicB) {
                        return 1; // 'b' is Basic, so it comes first
                    }

                    // If types are the same (both Basic or neither), sort by HP in ascending order
                    const hpA = parseInt(a.data.pokemon.hp, 10) || 0;
                    const hpB = parseInt(b.data.pokemon.hp, 10) || 0;
                    return hpA - hpB;
                });

                // Separate basic and evolved Pokémon
                const basicPokemon = pokemonInDeck.filter(item => item.data.pokemon.evolves === 'たね');
                const evolvedPokemon = pokemonInDeck.filter(item => item.data.pokemon.evolves !== 'たね');

                document.querySelectorAll('.empty-pokemon-select').forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Pokemon</option>';

                    // Add Basic Pokémon group
                    if (basicPokemon.length > 0) {
                        const basicOptgroup = document.createElement('optgroup');
                        basicOptgroup.label = '-たね-';
                        basicPokemon.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;

                            // Display Pokémon name, HP, and first attack name (safely)
                            const name = item.data.name;
                            const hp = item.data.pokemon.hp;
                            const firstAttackName = item.data.pokemon.attacks && item.data.pokemon.attacks.length > 0
                                ? item.data.pokemon.attacks[0].name
                                : 'No Attack';

                            option.textContent = `${name} (HP${hp}) - ${firstAttackName}`;
                            basicOptgroup.appendChild(option);
                        });
                        select.appendChild(basicOptgroup);
                    }

                    // Add Evolved Pokémon group
                    if (evolvedPokemon.length > 0) {
                        const evolvedOptgroup = document.createElement('optgroup');
                        evolvedOptgroup.label = '-進化-';
                        evolvedPokemon.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;
                            const name = item.data.name;
                            const hp = item.data.pokemon.hp;
                            const firstAttackName = item.data.pokemon.attacks && item.data.pokemon.attacks.length > 0
                                ? item.data.pokemon.attacks[0].name
                                : 'No Attack';
                            option.textContent = `${name} (HP${hp}) - ${firstAttackName}`;
                            evolvedOptgroup.appendChild(option);
                        });
                        select.appendChild(evolvedOptgroup);
                    }
                    select.value = currentValue;
                });
            };



            function syncCheckboxesWithSelections() {
                const currentSelections = selections.value || [];
                for (let i = 0; i < 9; i++) {
                    const slotEl = document.getElementById(`slot-R${i}`);
                    if (slotEl) {
                        const checkbox = slotEl.querySelector('.selection-checkbox');
                        const isSelected = currentSelections.includes(`slotR${i}`);
                        if (checkbox) {
                            checkbox.checked = isSelected;
                        }
                        slotEl.classList.toggle('selected', isSelected);
                    }
                }
            }

            // --- Swap / Position Change Logic ---
            function populateSwapDropdown(event) {
                const swapButton = event.relatedTarget;
                const sourceSlotEl = swapButton.closest('.pokemon-slot');
                const sourceSlotId = sourceSlotEl.id.replace('-', ''); // Remove hyphen!
                const menuEl = sourceSlotEl.querySelector('.swap-menu');
                
                menuEl.innerHTML = ''; // Clear existing items

                const db = cardDatabase.value;
                if (!db) return;

                for (let i = 0; i < 9; i++) {
                    const targetSlotId = `slotR${i}`;
                    if (sourceSlotId === targetSlotId) continue; // Don't list itself

                    // Insert a divider between 5 and 6
                    if (i === 6) {
                        const divider = document.createElement('li');
                        divider.innerHTML = '<hr class="dropdown-divider">';
                        menuEl.appendChild(divider);
                    }

                    const slotRep = nodecg.Replicant(`draft_${targetSlotId}`);
                    const slotData = slotRep.value;
                    
                    let targetName = `////EMPTY////`;
                    if (slotData && slotData.cardId && db[slotData.cardId]) {
                        targetName = db[slotData.cardId].name;
                    }

                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.classList.add('dropdown-item');
                    a.href = '#';
                    a.dataset.sourceSlot = sourceSlotId;
                    a.dataset.targetSlot = targetSlotId;
                    
                    let positionLabel = i === 0 ? 'Battle' : `Bench ${i}`;
                    a.textContent = `${positionLabel}: ${targetName}`;
                    
                    li.appendChild(a);
                    menuEl.appendChild(li);
                }
            }

            pokemonSlotsContainer.addEventListener('show.bs.dropdown', populateSwapDropdown);
            extraBenchContainer.addEventListener('show.bs.dropdown', populateSwapDropdown);

            pokemonSlotsContainer.addEventListener('click', function(event) {
                if (event.target.matches('.swap-menu .dropdown-item')) {
                    event.preventDefault();
                    const source = event.target.dataset.sourceSlot;
                    const target = event.target.dataset.targetSlot;
                    
                    if (source && target) {
                        queueOperation('SWITCH_POKEMON', { source, target });
                    }
                }
            });
            extraBenchContainer.addEventListener('click', function(event) {
                if (event.target.matches('.swap-menu .dropdown-item')) {
                    event.preventDefault();
                    const source = event.target.dataset.sourceSlot;
                    const target = event.target.dataset.targetSlot;
                    
                    if (source && target) {
                        queueOperation('SWITCH_POKEMON', { source, target });
                    }
                }
            });

            // --- Initialization & Listeners ---
            deckR.on('change', () => {
                updateAllEmptySlotDropdowns();
            });
            cardDatabase.on('change', () => {
                updateAllEmptySlotDropdowns();
            });
            selections.on('change', syncCheckboxesWithSelections);

            // When color settings change, re-render all slots to update their background color.
            settingsRep.on('change', () => {
                for (let i = 0; i < 9; i++) {
                    const slotReplicant = nodecg.Replicant(`draft_slotR${i}`);
                    renderSlot(i, slotReplicant.value, deckR.value, cardDatabase.value);
                }
            });

            for (let i = 0; i < 9; i++) {
                const slotReplicant = nodecg.Replicant(`draft_slotR${i}`); // <-- LISTEN TO DRAFT
                slotReplicant.on('change', (newValue) => {
                    if (renderSlotDebounce[i]) {
                        clearTimeout(renderSlotDebounce[i]);
                    }
                    renderSlotDebounce[i] = setTimeout(() => {
                        renderSlot(i, newValue, deckR.value, cardDatabase.value);
                    }, 16); // Debounce with a timeout roughly equivalent to one frame
                });
                renderSlot(i, slotReplicant.value, deckR.value, cardDatabase.value);
                setupSlotEventListeners(i);
            }
            
            updateAllEmptySlotDropdowns();
            syncCheckboxesWithSelections();

            // --- Hotkey Sender ---
            let hotkeys = { discard: 'Escape', apply: 'Control+S' };

            settingsRep.on('change', (newValue) => {
                if (newValue && newValue.hotkeys) {
                    hotkeys = newValue.hotkeys;
                } else {
                    hotkeys = { discard: 'Escape', apply: 'Control+S' };
                }
            });

            if (settingsRep.value && settingsRep.value.hotkeys) {
                hotkeys = settingsRep.value.hotkeys;
            }

            function checkHotkey(e, hotkeyString) {
                if (!hotkeyString || typeof hotkeyString !== 'string') return false;
                
                const parts = hotkeyString.toLowerCase().split('+').map(p => p.trim());
                const key = parts.pop();

                if (e.key.toLowerCase() !== key) return false;
                if (parts.includes('ctrl') !== e.ctrlKey) return false;
                if (parts.includes('alt') !== e.altKey) return false;
                if (parts.includes('shift') !== e.shiftKey) return false;
                if (parts.includes('meta') !== e.metaKey) return false; // For Command key on Mac

                return true;
            }

            document.addEventListener('keydown', (e) => {
                if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'SELECT') {
                    return;
                }

                if (checkHotkey(e, hotkeys.discard)) {
                    e.preventDefault();
                    nodecg.sendMessage('hotkeyFired', 'discard').catch(err => console.error("Error sending discard hotkey signal", err));
                } else if (checkHotkey(e, hotkeys.apply)) {
                    e.preventDefault();
                    nodecg.sendMessage('hotkeyFired', 'apply').catch(err => console.error("Error sending apply hotkey signal", err));
                } else if (checkHotkey(e, hotkeys.clearSelection)) {
                    e.preventDefault();
                    selections.value = [];
                }
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
